<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 设计尺寸：375×812px (iPhone 13) -->
    <!-- 产品类型：移动端App -->
    
    <!-- 核心技术栈 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Sans+SC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* 设备模拟容器 - 温暖治愈的米白色背景 */
        body.device-simulation {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            /* 温暖柔和的米白色基础渐变 */
            background: linear-gradient(135deg, #FAF7F2 0%, #F5F0E8 50%, #F2EDE4 100%);
            padding: 2rem;
            font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, sans-serif;
            position: relative;
            /* 极细微的噪点颗粒增加有机感 */
            background-image: 
                /* 亚麻编织纹理 */
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 0.5px,
                    rgba(139, 119, 101, 0.01) 0.5px,
                    rgba(139, 119, 101, 0.01) 1px
                ),
                repeating-linear-gradient(
                    -45deg,
                    transparent,
                    transparent 0.3px,
                    rgba(160, 142, 124, 0.008) 0.3px,
                    rgba(160, 142, 124, 0.008) 0.6px
                ),
                /* 极细微噪点效果 */
                radial-gradient(circle at 20% 30%, rgba(139, 119, 101, 0.005) 0%, transparent 1px),
                radial-gradient(circle at 80% 70%, rgba(160, 142, 124, 0.004) 0%, transparent 1px),
                radial-gradient(circle at 50% 50%, rgba(139, 119, 101, 0.003) 0%, transparent 2px),
                /* 主渐变背景 */
                linear-gradient(135deg, #FAF7F2 0%, #F5F0E8 50%, #F2EDE4 100%);
            /* 磨砂质感和自然光影 */
            box-shadow: 
                inset 0 0 120px rgba(139, 119, 101, 0.02),
                inset 0 0 60px rgba(160, 142, 124, 0.01);
        }
        
        /* 左上到右下的自然光效果 */
        body.device-simulation::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                /* 主光源：左上到右下的柔和光晕 */
                linear-gradient(135deg, 
                    rgba(255, 253, 250, 0.15) 0%, 
                    rgba(253, 251, 247, 0.08) 30%,
                    rgba(250, 247, 242, 0.04) 60%,
                    transparent 100%
                ),
                /* 次要光晕增强立体感 */
                radial-gradient(ellipse at 15% 20%, rgba(255, 253, 250, 0.12) 0%, transparent 40%),
                radial-gradient(ellipse at 85% 80%, rgba(245, 240, 232, 0.06) 0%, transparent 40%);
            pointer-events: none;
        }
        
        /* 增强纹理层的磨砂质感 */
        body.device-simulation::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            /* 细微的纸张/亚麻布质感 */
            background-image: 
                repeating-linear-gradient(90deg, transparent, transparent 50px, rgba(139, 119, 101, 0.003) 50px, rgba(139, 119, 101, 0.003) 51px),
                repeating-linear-gradient(0deg, transparent, transparent 50px, rgba(139, 119, 101, 0.003) 50px, rgba(139, 119, 101, 0.003) 51px);
            opacity: 0.5;
            pointer-events: none;
        }
        
        .mobile-frame {
            width: 375px;
            height: 812px;
            border: 16px solid #0f172a;
            border-radius: 48px;
            box-shadow: 
                0 32px 64px -16px rgba(15, 23, 42, 0.35),
                0 16px 32px -8px rgba(15, 23, 42, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.15),
                inset 0 -1px 0 rgba(0, 0, 0, 0.1);
            overflow: hidden;
            /* 使用与背景协调的温暖白色 */
            background: linear-gradient(135deg, #FFFEFA 0%, #FAF7F2 100%);
            position: relative;
            scroll-behavior: smooth;
            /* 增加细微的内部质感 */
            box-shadow: 
                0 32px 64px -16px rgba(15, 23, 42, 0.35),
                0 16px 32px -8px rgba(15, 23, 42, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.15),
                inset 0 -1px 0 rgba(0, 0, 0, 0.1),
                inset 0 0 40px rgba(245, 240, 232, 0.05);
        }
        
        /* 增强玻璃质感配合温暖背景 */
        .mobile-frame::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 40%;
            background: linear-gradient(
                180deg,
                rgba(255, 254, 250, 0.18) 0%,
                rgba(250, 247, 242, 0.08) 50%,
                rgba(245, 240, 232, 0.04) 100%
            );
            border-radius: 48px 48px 0 0;
            pointer-events: none;
            /* 增加轻微的磨砂效果 */
            filter: blur(0.5px);
        }
        
        /* 隐藏滚动条 */
        .mobile-frame::-webkit-scrollbar { display: none; }
        
        /* 8px网格系统基础 */
        :root {
            --spacing-unit: 8px;
            --radius-sm: calc(var(--spacing-unit) * 0.5);
            --radius-md: calc(var(--spacing-unit) * 1);
            --radius-lg: calc(var(--spacing-unit) * 2);
            --radius-xl: calc(var(--spacing-unit) * 3);
            --color-primary: #7CB342;
            --color-primary-dark: #558B2F;
            --color-primary-light: #9CCC65;
            --color-secondary: #5D4037;
            --color-secondary-light: #8D6E63;
            --bg-warm: #FFFEFA;
            --bg-cream: #FFF8E1;
            --bg-sage: #E8F5E8;
            --text-primary: #2D3748;
            --text-secondary: #4A5568;
            --text-muted: #718096;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
            --shadow-xl: 0 16px 32px rgba(0, 0, 0, 0.16);
        }
        
        /* 生命力动画系统 */
        @keyframes treeGrowth {
            0% { 
                transform: scale(0.6) rotate(-2deg); 
                opacity: 0; 
                filter: blur(2px);
            }
            30% { 
                transform: scale(1.1) rotate(1deg); 
                opacity: 0.8;
                filter: blur(0px);
            }
            60% { 
                transform: scale(0.95) rotate(-0.5deg); 
                opacity: 0.95;
            }
            100% { 
                transform: scale(1) rotate(0deg); 
                opacity: 1;
            }
        }
        
        @keyframes treeBreath {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.02) rotate(0.5deg); }
        }

        /* 交错动画系统 */
        @keyframes fadeInUp {
            0% {
                opacity: 0;
                transform: translateY(30px) scale(0.9);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes fadeInScale {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes slideInLeft {
            0% {
                opacity: 0;
                transform: translateX(-30px);
            }
            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInRight {
            0% {
                opacity: 0;
                transform: translateX(30px);
            }
            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* 交错动画类 */
        .stagger-item {
            opacity: 0;
            animation-fill-mode: both;
        }

        /* 树图标特殊处理 - 确保始终可见并正确动画 */
        .stagger-tree {
            opacity: 1;
            animation: treeGrowth 1.2s cubic-bezier(0.34, 1.56, 0.64, 1) forwards,
                      treeBreath 4s ease-in-out 1.5s infinite;
        }

        .stagger-title-root {
            animation: fadeInScale 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        .stagger-title-journey {
            animation: fadeInScale 0.8s cubic-bezier(0.4, 0, 0.2, 1) 0.2s forwards;
        }

        .stagger-subtitle {
            animation: fadeInUp 0.8s cubic-bezier(0.4, 0, 0.2, 1) 0.4s forwards;
        }

        .stagger-button {
            animation: slideInUp 0.8s cubic-bezier(0.4, 0, 0.2, 1) 0.6s forwards;
        }

        .stagger-decoration {
            animation: slideInLeft 0.8s cubic-bezier(0.4, 0, 0.2, 1) 0.8s forwards;
        }

        @keyframes slideInUp {
            0% {
                opacity: 0;
                transform: translateY(40px) scale(0.95);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        /* 三级页面样式 - 允许滑动 */
        #form-page {
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        @keyframes progressFill {
            0% { 
                width: 0%; 
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            100% { 
                width: 60%; 
            }
        }
        
        @keyframes cardEntrance {
            0% { 
                opacity: 0; 
                transform: translateY(24px) scale(0.95);
            }
            100% { 
                opacity: 1; 
                transform: translateY(0) scale(1);
            }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-3px); }
        }
        
        .tree-icon {
            animation: treeGrowth 1.2s cubic-bezier(0.34, 1.56, 0.64, 1) forwards,
                      treeBreath 4s ease-in-out 1.5s infinite;
        }
        
        .progress-fill {
            animation: progressFill 2s cubic-bezier(0.4, 0, 0.2, 1) 0.8s forwards;
        }
        
        .story-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            animation: cardEntrance 0.8s ease-out backwards;
        }
        
        .story-card:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .story-card:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow: 
                0 12px 32px rgba(124, 179, 66, 0.2),
                0 4px 12px rgba(124, 179, 66, 0.15);
        }
        
        /* 增强按钮交互 */
        .btn-primary {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
            transition: width 0.6s, height 0.6s;
            transform: translate(-50%, -50%);
            border-radius: 50%;
        }
        
        .btn-primary:hover::before {
            width: 200%;
            height: 200%;
        }
        
        .btn-primary:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 
                0 8px 24px rgba(124, 179, 66, 0.35),
                0 2px 8px rgba(124, 179, 66, 0.25);
        }
        
        .btn-primary:active {
            transform: translateY(-1px) scale(1.02);
        }
        
        /* 页面容器 */
        .pages-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        /* 页面切换动画 */
        .page-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
            pointer-events: none;
            z-index: 1;
            display: none;
        }
        
        .page-content.active {
            opacity: 1;
            transform: translateX(0);
            pointer-events: auto;
            z-index: 10;
            display: block;
        }
        
        /* 脉冲动画 */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        /* 菜单滑下动画 */
        @keyframes slideDown {
            0% {
                opacity: 0;
                transform: translateY(-10px) scale(0.95);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        /* 菜单滑上动画 */
        @keyframes slideUp {
            0% {
                opacity: 0;
                transform: translateY(10px) scale(0.95);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* 尊重用户减少动效偏好 */
        @media (prefers-reduced-motion: reduce) {
            .tree-icon,
            .progress-fill,
            .story-card,
            .btn-primary,
            .page-content,
            .stagger-item,
            .stagger-tree,
            .stagger-title-root,
            .stagger-title-journey,
            .stagger-subtitle,
            .stagger-button,
            .stagger-decoration {
                animation: none;
                transition: none;
                opacity: 1;
                transform: none;
            }
        }
    </style>
</head>
<body class="device-simulation">
    <!-- 移动设备外框 -->
    <div class="mobile-frame">

        <!-- 页面容器 -->
        <div class="pages-container">
        
        <!-- 欢迎页面 - 新的一级页面 -->
        <main id="welcome-page" class="px-4 page-content active">
            <!-- 形象化标题区域 -->
            <header class="relative flex flex-col items-center justify-center" style="margin-top: calc(var(--spacing-unit) * 6); margin-bottom: calc(var(--spacing-unit) * 2);">
                <!-- 背景装饰圆形 -->
                <div class="absolute inset-0 flex items-center justify-center">
                    <div class="w-64 h-64 rounded-full opacity-20" style="background: radial-gradient(circle, rgba(124, 179, 66, 0.15) 0%, transparent 70%);
                                filter: blur(20px);"></div>
                </div>
                
                <!-- 树与标题组合 -->
                <div class="relative flex flex-col items-center">
                    <div class="relative w-28 h-28 flex items-center justify-center mb-8">
                        <!-- 温暖光晕效果 -->
                        <div class="absolute inset-0 rounded-full" style="background: radial-gradient(circle, rgba(124, 179, 66, 0.25) 0%, transparent 70%);
                                    filter: blur(15px);"></div>
                        <!-- 树形状清晰的艺术绘画 -->
                        <div class="tree-icon relative z-10 stagger-tree">
                            <svg width="112" height="112" viewBox="0 0 64 64" fill="none">
                            <!-- 专业水彩画滤镜 -->
                            <defs>
                                <!-- 水彩晕染 -->
                                <filter id="treeWatercolor">
                                    <feTurbulence type="fractalNoise" baseFrequency="0.02" numOctaves="4" result="turbulence" seed="10"></feTurbulence>
                                    <feGaussianBlur in="turbulence" stdDeviation="1.5" result="blur"></feGaussianBlur>
                                    <feColorMatrix in="blur" type="saturate" values="0.7" result="colored"></feColorMatrix>
                                    <feComponentTransfer in="colored">
                                        <feFuncA type="discrete" tableValues="0 0.2 0.4 0.6 0.8 1"></feFuncA>
                                    </feComponentTransfer>
                                </filter>
                                
                                <!-- 纸纹理 -->
                                <filter id="canvasPaper">
                                    <feTurbulence type="fractalNoise" baseFrequency="0.15" numOctaves="3" result="noise" seed="5"></feTurbulence>
                                    <feColorMatrix in="noise" type="saturate" values="0"></feColorMatrix>
                                    <feComponentTransfer>
                                        <feFuncA type="discrete" tableValues="0 0.02 0.04 0.06 0.08"></feFuncA>
                                    </feComponentTransfer>
                                    <feGaussianBlur stdDeviation="0.6"></feGaussianBlur>
                                </filter>
                                
                                <!-- 水彩边缘 -->
                                <filter id="softWatercolorEdge">
                                    <feGaussianBlur stdDeviation="1.2"></feGaussianBlur>
                                    <feComponentTransfer>
                                        <feFuncA type="discrete" tableValues="0 0.3 0.5 0.7 0.85 1"></feFuncA>
                                    </feComponentTransfer>
                                </filter>
                                
                                <!-- 颜料纹理 -->
                                <filter id="brushTexture">
                                    <feTurbulence type="turbulence" baseFrequency="0.06" numOctaves="2" result="turbulence"></feTurbulence>
                                    <feColorMatrix in="turbulence" type="saturate" values="0.4"></feColorMatrix>
                                    <feComponentTransfer>
                                        <feFuncA type="discrete" tableValues="0 0.2 0.4 0.6 0.8"></feFuncA>
                                    </feComponentTransfer>
                                    <feComposite in="SourceGraphic" operator="multiply"></feComposite>
                                </filter>
                                
                                <!-- 树叶绿色系 -->
                                <radialGradient id="leafGreenDark" cx="50%" cy="50%">
                                    <stop offset="0%" style="stop-color:#2E7D32;stop-opacity:0.9"></stop>
                                    <stop offset="50%" style="stop-color:#388E3C;stop-opacity:0.7"></stop>
                                    <stop offset="100%" style="stop-color:#4CAF50;stop-opacity:0.4"></stop>
                                </radialGradient>
                                
                                <radialGradient id="leafGreenMedium" cx="50%" cy="50%">
                                    <stop offset="0%" style="stop-color:#4CAF50;stop-opacity:0.85"></stop>
                                    <stop offset="60%" style="stop-color:#66BB6A;stop-opacity:0.6"></stop>
                                    <stop offset="100%" style="stop-color:#81C784;stop-opacity:0.3"></stop>
                                </radialGradient>
                                
                                <radialGradient id="leafGreenLight" cx="50%" cy="50%">
                                    <stop offset="0%" style="stop-color:#66BB6A;stop-opacity:0.8"></stop>
                                    <stop offset="70%" style="stop-color:#81C784;stop-opacity:0.5"></stop>
                                    <stop offset="100%" style="stop-color:#A5D6A7;stop-opacity:0.2"></stop>
                                </radialGradient>
                                
                                <!-- 树干褐色 -->
                                <linearGradient id="trunkBrown" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#5D4037;stop-opacity:0.95"></stop>
                                    <stop offset="50%" style="stop-color:#6D4C41;stop-opacity:0.8"></stop>
                                    <stop offset="100%" style="stop-color:#795548;stop-opacity:0.6"></stop>
                                </linearGradient>
                                
                                <!-- 背景光 -->
                                <radialGradient id="backgroundGlow" cx="50%" cy="50%">
                                    <stop offset="0%" style="stop-color:#E8F5E9;stop-opacity:0.3"></stop>
                                    <stop offset="60%" style="stop-color:#C8E6C9;stop-opacity:0.15"></stop>
                                    <stop offset="100%" style="stop-color:#A5D6A7;stop-opacity:0.05"></stop>
                                </radialGradient>
                            </defs>
                            
                            <!-- 画纸背景 -->
                            <rect x="0" y="0" width="64" height="64" fill="#FAFAFA" opacity="0.95" filter="url(#canvasPaper)"></rect>
                            
                            <!-- 背景光晕 -->
                            <ellipse cx="32" cy="30" rx="28" ry="28" fill="url(#backgroundGlow)" opacity="0.4" filter="url(#treeWatercolor)"></ellipse>
                            
                            <!-- 清晰的树干结构 -->
                            <g filter="url(#brushTexture)">
                                <!-- 主树干 -->
                                <path d="M32 42 L32 56" stroke="url(#trunkBrown)" stroke-width="4" stroke-linecap="round" fill="none" filter="url(#softWatercolorEdge)" opacity="0.9"></path>
                                
                                <!-- 树干阴影 -->
                                <path d="M34 42 L34 56" stroke="#3E2723" stroke-width="2.5" stroke-linecap="round" fill="none" filter="url(#softWatercolorEdge)" opacity="0.5"></path>
                                
                                <!-- 树干纹理 -->
                                <path d="M30 46 L34 46 M30 50 L34 50 M30 54 L34 54" stroke="#6D4C41" stroke-width="0.8" stroke-linecap="round" fill="none" filter="url(#brushTexture)" opacity="0.7"></path>
                                
                                <!-- 分叉树枝 -->
                                <path d="M32 42 L28 38 M32 42 L36 38" stroke="url(#trunkBrown)" stroke-width="2.5" stroke-linecap="round" fill="none" filter="url(#softWatercolorEdge)" opacity="0.8"></path>
                                
                                <!-- 树根 -->
                                <path d="M30 56 L26 60 M34 56 L38 60 M32 56 L32 61" stroke="url(#trunkBrown)" stroke-width="2" stroke-linecap="round" fill="none" filter="url(#softWatercolorEdge)" opacity="0.6"></path>
                            </g>
                            
                            <!-- 清晰的树冠形状 - 三层结构 -->
                            <g filter="url(#treeWatercolor)">
                                <!-- 下层树冠 - 最宽大 -->
                                <g filter="url(#brushTexture)">
                                    <!-- 左下叶簇 -->
                                    <ellipse cx="22" cy="35" rx="8" ry="10" fill="url(#leafGreenLight)" opacity="0.7" filter="url(#softWatercolorEdge)" transform="rotate(-25 22 35)"></ellipse>
                                    
                                    <!-- 右下叶簇 -->
                                    <ellipse cx="42" cy="35" rx="8" ry="10" fill="url(#leafGreenLight)" opacity="0.7" filter="url(#softWatercolorEdge)" transform="rotate(25 42 35)"></ellipse>
                                    
                                    <!-- 中下叶簇 -->
                                    <ellipse cx="32" cy="38" rx="10" ry="8" fill="url(#leafGreenMedium)" opacity="0.75" filter="url(#softWatercolorEdge)"></ellipse>
                                </g>
                                
                                <!-- 中层树冠 - 主要层次 -->
                                <g filter="url(#brushTexture)">
                                    <!-- 左中叶簇 -->
                                    <ellipse cx="25" cy="28" rx="9" ry="11" fill="url(#leafGreenMedium)" opacity="0.8" filter="url(#softWatercolorEdge)" transform="rotate(-15 25 28)"></ellipse>
                                    
                                    <!-- 右中叶簇 -->
                                    <ellipse cx="39" cy="28" rx="9" ry="11" fill="url(#leafGreenMedium)" opacity="0.8" filter="url(#softWatercolorEdge)" transform="rotate(15 39 28)"></ellipse>
                                    
                                    <!-- 中心叶簇 -->
                                    <ellipse cx="32" cy="30" rx="11" ry="9" fill="url(#leafGreenDark)" opacity="0.85" filter="url(#softWatercolorEdge)"></ellipse>
                                </g>
                                
                                <!-- 上层树冠 - 顶尖层次 -->
                                <g filter="url(#brushTexture)">
                                    <!-- 左上叶簇 -->
                                    <ellipse cx="28" cy="20" rx="7" ry="9" fill="url(#leafGreenDark)" opacity="0.9" filter="url(#softWatercolorEdge)" transform="rotate(-10 28 20)"></ellipse>
                                    
                                    <!-- 右上叶簇 -->
                                    <ellipse cx="36" cy="20" rx="7" ry="9" fill="url(#leafGreenDark)" opacity="0.9" filter="url(#softWatercolorEdge)" transform="rotate(10 36 20)"></ellipse>
                                    
                                    <!-- 顶部叶簇 -->
                                    <ellipse cx="32" cy="18" rx="6" ry="7" fill="url(#leafGreenDark)" opacity="0.95" filter="url(#softWatercolorEdge)"></ellipse>
                                </g>
                                
                                <!-- 连接树枝 -->
                                <g filter="url(#softWatercolorEdge)">
                                    <!-- 主要树枝 -->
                                    <path d="M32 42 L25 28 L28 20 M32 42 L39 28 L36 20" stroke="url(#trunkBrown)" stroke-width="2" stroke-linecap="round" fill="none" opacity="0.7"></path>
                                    
                                    <!-- 细小树枝 -->
                                    <path d="M25 28 L22 35 M39 28 L42 35 M28 20 L32 18 M36 20 L32 18" stroke="#6D4C41" stroke-width="1.2" stroke-linecap="round" fill="none" opacity="0.6"></path>
                                </g>
                            </g>
                            
                            <!-- 艺术细节和高光 -->
                            <g filter="url(#softWatercolorEdge)">
                                <!-- 水彩颜料点 -->
                                <circle cx="24" cy="25" r="1.8" fill="#66BB6A" opacity="0.4" filter="url(#treeWatercolor)"></circle>
                                <circle cx="40" cy="26" r="1.5" fill="#66BB6A" opacity="0.35" filter="url(#treeWatercolor)"></circle>
                                <circle cx="30" cy="18" r="1.2" fill="#4CAF50" opacity="0.5" filter="url(#treeWatercolor)"></circle>
                                <circle cx="34" cy="19" r="1" fill="#4CAF50" opacity="0.45" filter="url(#treeWatercolor)"></circle>
                                <circle cx="32" cy="30" r="1.6" fill="#388E3C" opacity="0.3" filter="url(#treeWatercolor)"></circle>
                                
                                <!-- 高光效果 -->
                                <ellipse cx="26" cy="22" rx="2.5" ry="1.8" fill="white" opacity="0.3" filter="url(#softWatercolorEdge)"></ellipse>
                                <ellipse cx="38" cy="24" rx="2" ry="1.5" fill="white" opacity="0.25" filter="url(#softWatercolorEdge)"></ellipse>
                                <ellipse cx="32" cy="16" rx="1.8" ry="1.2" fill="white" opacity="0.35" filter="url(#softWatercolorEdge)"></ellipse>
                            </g>
                        </svg>
                        </div>
                    </div>
                </div>
                
                <!-- Root Journey 标题居中显示 -->
                <div class="relative z-10 text-center mb-8">
                    <h1 class="font-black" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; color: #2E4B2C; letter-spacing: 0.2em; font-weight: 900; text-shadow: rgba(46, 75, 44, 0.2) 3px 3px 6px; line-height: 1.2; font-size: 56px;">
                        <div class="stagger-item stagger-title-root">Root</div>
                        <div class="stagger-item stagger-title-journey">Journey</div>
                    </h1>
                </div>
                
                <!-- 欢迎文字 -->
                <div class="text-center mb-12">
                    <p class="text-lg stagger-item stagger-subtitle" style="color: rgb(93, 64, 55); opacity: 0.8; line-height: 1.8; max-width: 300px; margin: 0px auto; font-weight: 400; font-size: 20px; font-family: 'Ma Shan Zheng', cursive, 'Noto Sans SC', sans-serif; letter-spacing: 0.1em; text-shadow: 1px 1px 2px rgba(0,0,0,0.05);">从离散的独白到共鸣的合唱</p>
                </div>
                
            </header>
            
            <!-- 欢迎使用按钮 - 优化布局 -->
            <div class="flex justify-center mb-8 mt-6">
                <button onclick="showHomePage()" class="relative w-48 rounded-2xl 
                                       transition-all duration-500 
                                       group
                                       hover:shadow-2xl
                                       hover:scale-[1.02]
                                       active:scale-[0.98]
                                       overflow-hidden stagger-item stagger-button" 
                        style="height: 56px; 
                               background: linear-gradient(135deg, #2E4B2C 0%, #3A5A3A 100%);
                               border: 1px solid rgba(255, 255, 255, 0.2);
                               box-shadow: 0 8px 32px rgba(46, 75, 44, 0.35), 0 4px 16px rgba(46, 75, 44, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.15);">
                    <!-- 按钮内容 -->
                    <div class="flex items-center justify-center gap-3 h-full relative z-10">
                        <!-- 白色实心圆圈包围的白色爱心 -->
                        <div class="relative w-10 h-10 rounded-full bg-white flex items-center justify-center" style="box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.08), inset 0 1px 2px rgba(255, 255, 255, 0.9);">
                            <!-- 白色爱心图标 -->
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="#2E4B2C" style="filter: drop-shadow(0 1px 2px rgba(46, 75, 44, 0.2));">
                                <path d="M12,21.35L10.55,20.03C5.4,15.36 2,12.27 2,8.5C2,5.41 4.42,3 7.5,3C9.24,3 10.91,3.81 12,5.08C13.09,3.81 14.76,3 16.5,3C19.58,3 22,5.41 22,8.5C22,12.27 18.6,15.36 13.45,20.03L12,21.35Z"></path>
                            </svg>
                            <!-- 爱心光晕 -->
                            <div class="absolute inset-0 rounded-full" style="background: radial-gradient(circle, rgba(46, 75, 44, 0.1) 0%, transparent 70%);"></div>
                        </div>
                        
                        <span style="color: white; font-size: 16px; font-weight: 600; font-family: 'Noto Sans SC', sans-serif; letter-spacing: 0.05em; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);">开始使用</span>
                    </div>
                    
                    <!-- 悬停效果层 - 增强 -->
                    <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-all duration-500" 
                         style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.08) 50%, transparent 100%); 
                                box-shadow: inset 0 2px 8px rgba(255, 255, 255, 0.2);
                                pointer-events: none;"></div>
                    
                    <!-- 光泽扫过效果 -->
                    <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-700 overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white to-transparent opacity-20 transform -skew-x-12 translate-x-full group-hover:translate-x-full transition-transform duration-1000"></div>
                    </div>
                </button>
            </div>
            
            <!-- 装饰元素 -->
            <div class="flex justify-center stagger-item stagger-decoration">
                <svg width="150" height="40" viewBox="0 0 150 40">
                    <g fill="none" stroke="#D4AF37" stroke-width="1" opacity="0.3">
                        <path d="M30,20 Q50,15 70,20 T110,20 Q130,15 140,20"></path>
                        <circle cx="50" cy="18" r="1.5" fill="#D4AF37"></circle>
                        <circle cx="100" cy="18" r="1.5" fill="#D4AF37"></circle>
                    </g>
                </svg>
            </div>

            
               
        </main>
        
        <!-- 主内容区域 - 家谱页面 -->
        <main id="home-page" class="px-4 page-content">
            <!-- 页面标题居中容器 -->
            <div class="flex flex-col items-center justify-center h-full py-8">
                <!-- 页面标题 - 优化布局 -->
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold" style="font-size: 32px; font-weight: 700; font-family: 'Noto Sans SC', serif; color: #2E4B2C; line-height: 1.4; letter-spacing: 0.08em; text-shadow: 2px 2px 4px rgba(46, 75, 44, 0.15);">我的家族故事</h2>
                </div>
                
                <!-- 主卡片容器 - 模糊化透明背景 -->
                <div class="relative w-full max-w-sm mx-auto" style="border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 32px; padding: 2px; background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1), 0 2px 8px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.2);">
                    <!-- 内部容器 - 高级光影效果 -->
                    <div class="bg-white bg-opacity-10 rounded-[30px] p-8 relative overflow-hidden" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); box-shadow: inset 0 2px 8px rgba(255, 255, 255, 0.3), inset 0 -2px 8px rgba(0, 0, 0, 0.05);">
                        <!-- 光影效果层 -->
                        <div class="absolute inset-0" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, transparent 50%, rgba(46, 75, 44, 0.05) 100%); pointer-events: none;"></div>
                        <div class="absolute inset-0" style="background: radial-gradient(circle at 30% 20%, rgba(255, 255, 255, 0.3) 0%, transparent 40%); pointer-events: none;"></div>
                        
                        <!-- 可交互头像区域 - 上传照片和现场拍照 -->
                        <div class="flex justify-center mb-10">
                            <div class="relative group" style="width: 220px; height: 220px;">
                                <!-- 头像容器 -->
                                <div id="avatar-container" class="relative w-full h-full rounded-full overflow-hidden cursor-pointer transition-all duration-300 hover:scale-[1.02]" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(250, 247, 242, 0.85) 50%, rgba(245, 240, 232, 0.75) 100%); box-shadow: 0 16px 48px rgba(0, 0, 0, 0.18), 0 6px 16px rgba(0, 0, 0, 0.1), inset 0 4px 8px rgba(255, 255, 255, 0.95), inset 0 -4px 8px rgba(0, 0, 0, 0.06); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);">
                                    <!-- 外圈装饰 -->
                                    <div class="absolute inset-0 rounded-full" style="border: 5px solid transparent; background: linear-gradient(135deg, rgba(212, 175, 55, 0.7) 0%, rgba(184, 134, 11, 0.5) 50%, rgba(212, 175, 55, 0.7) 100%) border-box; mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0); mask-composite: exclude; -webkit-mask-composite: xor; box-shadow: 0 0 25px rgba(212, 175, 55, 0.4), inset 0 0 12px rgba(212, 175, 55, 0.25);"></div>
                                    
                                    <!-- 头像图片或默认头像 -->
                                    <div id="avatar-display" class="relative w-full h-full rounded-full overflow-hidden">
                                        <!-- 默认SVG头像 -->
                                        <svg id="default-avatar" width="90" height="90" viewBox="0 0 24 24" fill="none" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2" style="stroke: #2E4B2C; stroke-width: 1.5px; stroke-linecap: round; stroke-linejoin: round; filter: drop-shadow(0 4px 8px rgba(46, 75, 44, 0.3));">
                                            <!-- 头发后层 -->
                                            <path d="M7 6c1-2.5 3-4 5-4s4 1.5 5 4c0.5 1.2 0.5 2.5 0 3.5" stroke-width="2" fill="none" opacity="0.8"/>
                                            
                                            <!-- 脸部轮廓 -->
                                            <ellipse cx="12" cy="10" rx="6.5" ry="7.5" fill="rgba(255, 248, 240, 0.8)" stroke-width="2"/>
                                            
                                            <!-- 眼睛 -->
                                            <path d="M9 10c0.5-0.5 1.5-0.5 2 0" stroke-width="1.5" stroke-linecap="round"/>
                                            <path d="M13 10c0.5-0.5 1.5-0.5 2 0" stroke-width="1.5" stroke-linecap="round"/>
                                            <circle cx="10" cy="10" r="0.5" fill="#2E4B2C"/>
                                            <circle cx="14" cy="10" r="0.5" fill="#2E4B2C"/>
                                            
                                            <!-- 鼻子 -->
                                            <path d="M12 12l0 1.5" stroke-width="1.5" stroke-linecap="round"/>
                                            
                                            <!-- 嘴巴 -->
                                            <path d="M9.5 15c1 0.5 2.5 0.5 3.5 0" stroke-width="1.5" stroke-linecap="round"/>
                                            
                                            <!-- 耳朵 -->
                                            <path d="M5 10c0-1 0.5-1.5 1-1.5" stroke-width="1.5" fill="none"/>
                                            <path d="M19 10c0-1 -0.5-1.5 -1-1.5" stroke-width="1.5" fill="none"/>
                                            
                                            <!-- 颈部 -->
                                            <rect x="10" y="17" width="4" height="3" fill="rgba(255, 248, 240, 0.8)" stroke-width="1.5"/>
                                            
                                            <!-- 肩膀和身体 -->
                                            <path d="M8 20c0-1 1-2 4-2s4 1 4 2v2H8v-2z" fill="rgba(255, 248, 240, 0.8)" stroke-width="2"/>
                                            
                                            <!-- 衣领 -->
                                            <path d="M8 19h12M8 21h12" stroke-width="1" opacity="0.6"/>
                                            
                                            <!-- 头发前层 -->
                                            <path d="M6 7c0.8-1.8 2.8-3 5-3.5 2.2-0.5 4.2 0 5.5 1.5" stroke-width="2" fill="none"/>
                                            
                                            <!-- 腮红 -->
                                            <ellipse cx="7.5" cy="12" rx="1" ry="0.8" fill="rgba(255, 182, 193, 0.3)"/>
                                            <ellipse cx="16.5" cy="12" rx="1" ry="0.8" fill="rgba(255, 182, 193, 0.3)"/>
                                            
                                            <!-- 眼睛高光 -->
                                            <circle cx="10.2" cy="9.5" r="0.3" fill="white" opacity="0.8"/>
                                            <circle cx="14.2" cy="9.5" r="0.3" fill="white" opacity="0.8"/>
                                        </svg>
                                        
                                        <!-- 上传的图片（初始隐藏） -->
                                        <img id="uploaded-avatar" class="absolute inset-0 w-full h-full object-cover rounded-full hidden" alt="用户头像">
                                    </div>
                                    
                                    <!-- 光泽效果 -->
                                    <div class="absolute top-8 left-10 w-14 h-20 rounded-full" style="background: linear-gradient(180deg, rgba(255, 255, 255, 0.8) 0%, transparent 60%); filter: blur(4px);"></div>
                                    <div class="absolute top-6 right-8 w-8 h-12 rounded-full" style="background: linear-gradient(45deg, rgba(255, 255, 255, 0.6) 0%, transparent 70%); filter: blur(3px);"></div>
                                    
                                    <!-- 动态光效 -->
                                    <div class="absolute inset-0 rounded-full animate-pulse" style="background: radial-gradient(circle, rgba(46, 75, 44, 0.05) 0%, transparent 60%); animation: pulse 3s ease-in-out infinite;"></div>
                                    
                                    <!-- 悬停时的相机图标遮罩 -->
                                    <div class="absolute inset-0 rounded-full bg-black bg-opacity-40 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center">
                                        <svg width="32" height="32" viewBox="0 0 24 24" fill="white" class="transform hover:scale-110 transition-transform duration-200">
                                            <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.67 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"></path>
                                        </svg>
                                    </div>
                                </div>
                                
                                <!-- 隐藏的文件输入 -->
                                <input type="file" id="avatar-input" accept="image/*" capture="environment" class="hidden">
                                
                                <!-- 质量检测提示 -->
                                <div id="quality-alert" class="absolute -bottom-8 left-1/2 transform -translate-x-1/2 px-3 py-1 rounded-full text-xs font-medium hidden" style="background: rgba(255, 152, 0, 0.9); color: white; backdrop-filter: blur(10px);"></div>
                            </div>
                        </div>
                        
                        <!-- 头像操作说明 -->
                        <div class="text-center mb-8 text-sm" style="color: #5D4037; opacity: 0.7; font-family: 'Noto Sans SC', sans-serif;">
                            点击头像上传照片或拍照
                        </div>
                        
                        <!-- 操作按钮 - 墨绿色填充 -->
                        <button onclick="showFormPageFromHome()" 
                                class="relative w-full rounded-2xl 
                                       transition-all duration-500 
                                       group
                                       hover:shadow-2xl
                                       hover:scale-[1.02]
                                       active:scale-[0.98]
                                       overflow-hidden" 
                                style="height: 70px; 
                                       background: linear-gradient(135deg, #2E4B2C 0%, #3A5A3A 100%);
                                       border: 1px solid rgba(255, 255, 255, 0.2);
                                       box-shadow: 0 8px 32px rgba(46, 75, 44, 0.35), 0 4px 16px rgba(46, 75, 44, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.15);">
                            <!-- 按钮内容 -->
                            <div class="flex items-center justify-center gap-4 h-full relative z-10">
                                <!-- 白色实心圆圈包围的墨绿色加号 -->
                                <div class="relative w-12 h-12 rounded-full bg-white flex items-center justify-center" style="box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.08), inset 0 1px 2px rgba(255, 255, 255, 0.9);">
                                    <!-- 墨绿色加号 -->
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="#2E4B2C" style="filter: drop-shadow(0 1px 2px rgba(46, 75, 44, 0.2));">
                                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path>
                                    </svg>
                                    <!-- 加号光晕 -->
                                    <div class="absolute inset-0 rounded-full" style="background: radial-gradient(circle, rgba(46, 75, 44, 0.1) 0%, transparent 70%);"></div>
                                </div>
                                
                                <span style="color: white; font-size: 18px; font-weight: 600; font-family: 'Noto Sans SC', sans-serif; letter-spacing: 0.05em; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);">添加故事</span>
                            </div>
                            
                            <!-- 悬停效果层 - 增强 -->
                            <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-all duration-500" 
                                 style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.08) 50%, transparent 100%); 
                                        box-shadow: inset 0 2px 8px rgba(255, 255, 255, 0.2);
                                        pointer-events: none;"></div>
                            
                            <!-- 光泽扫过效果 -->
                            <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-700 overflow-hidden">
                                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white to-transparent opacity-20 transform -skew-x-12 translate-x-full group-hover:translate-x-full transition-transform duration-1000"></div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- 信息采集表单页面 -->
        <main id="form-page" class="px-4 page-content">
            <!-- 返回按钮 -->
            <div class="flex items-center justify-start pt-6 pb-2">
                <button onclick="showMainPage()" class="flex items-center justify-center text-base px-3 py-2 rounded-full transition-all duration-300 hover:bg-opacity-10 hover:bg-[#2E4B2C]" style="color: #2E4B2C; font-family: 'Noto Sans SC', serif; width: 40px; height: 40px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z"></path>
                    </svg>
                </button>
            </div>
            
            <!-- 页面标题 -->
            <div class="text-center mb-6" style="margin-top: -20px;">
                <div class="text-center">
                    <h2 class="text-3xl font-bold" style="font-size: 32px; font-weight: 700; font-family: 'Noto Sans SC', serif; color: #2E4B2C; line-height: 1.4; letter-spacing: 0.08em; text-shadow: 2px 2px 4px rgba(46, 75, 44, 0.15);">
                        Step 1
                    </h2>
                    <h2 class="text-3xl font-bold mt-2" style="font-size: 32px; font-weight: 700; font-family: 'Noto Sans SC', serif; color: #2E4B2C; line-height: 1.4; letter-spacing: 0.08em; text-shadow: 2px 2px 4px rgba(46, 75, 44, 0.15);">
                        个人基本信息
                    </h2>
                </div>
            </div>
            
            <!-- 信息采集表单 - 透明模糊背景 -->
            <div class="relative rounded-2xl overflow-hidden" style="border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 32px; padding: 2px; background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1), 0 2px 8px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.2);">
                <!-- 内部容器 - 高级光影效果 -->
                <div class="bg-white bg-opacity-10 rounded-[30px] p-6 relative overflow-hidden" style="background: linear-gradient(180deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); box-shadow: inset 0 2px 8px rgba(255, 255, 255, 0.3), inset 0 -2px 8px rgba(0, 0, 0, 0.05);">
                    <!-- 光影效果层 -->
                    <div class="absolute inset-0" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, transparent 50%, rgba(46, 75, 44, 0.05) 100%); pointer-events: none;"></div>
                    <div class="absolute inset-0" style="background: radial-gradient(circle at 30% 20%, rgba(255, 255, 255, 0.3) 0%, transparent 40%); pointer-events: none;"></div>
                    
                    <div class="relative z-10">
                        <!-- 姓名输入 -->
                        <div class="mb-6">
                            <label class="flex items-center text-base font-medium mb-3" style="font-family: 'Noto Sans SC', serif; 
                                          color: #2E4B2C; 
                                          letter-spacing: 0.05em;">
                                <span>姓名</span>
                                <span class="text-lg ml-2">👤</span>
                            </label>
                            <input type="text" id="name-input" placeholder="请输入姓名" class="w-full px-4 py-3 rounded-lg border border-solid transition-all duration-300" style="background: rgba(255, 255, 255, 0.9);
                                          border-color: rgba(255, 255, 255, 0.3);
                                          color: #2E4B2C;
                                          font-family: 'Noto Sans SC', sans-serif;
                                          font-size: 1rem;
                                          backdrop-filter: blur(10px);
                                          -webkit-backdrop-filter: blur(10px);">
                            <div id="name-error" class="text-red-500 text-sm mt-1 hidden" style="font-family: 'Noto Sans SC', sans-serif;">姓名格式不正确</div>
                        </div>
                        
                        <!-- 性别选择 -->
                        <div class="mb-6">
                            <label class="flex items-center text-base font-medium mb-3" style="font-family: 'Noto Sans SC', serif; 
                                          color: #2E4B2C; 
                                          letter-spacing: 0.05em;">
                                <span>性别</span>
                                <span class="text-lg ml-2">⚧️</span>
                            </label>
                            <div class="flex gap-4">
                                <label class="flex items-center gap-2 px-4 py-3 rounded-lg border border-solid cursor-pointer transition-all duration-300 hover:bg-white hover:bg-opacity-30" style="background: rgba(255, 255, 255, 0.8);
                                              border-color: rgba(255, 255, 255, 0.3);
                                              font-family: 'Noto Sans SC', sans-serif;
                                              font-size: 1rem;">
                                    <input type="radio" name="gender" value="male" class="text-[#2E4B2C] focus:ring-[#2E4B2C]">
                                    <span>男</span>
                                </label>
                                <label class="flex items-center gap-2 px-4 py-3 rounded-lg border border-solid cursor-pointer transition-all duration-300 hover:bg-white hover:bg-opacity-30" style="background: rgba(255, 255, 255, 0.8);
                                              border-color: rgba(255, 255, 255, 0.3);
                                              font-family: 'Noto Sans SC', sans-serif;
                                              font-size: 1rem;">
                                    <input type="radio" name="gender" value="female" class="text-[#2E4B2C] focus:ring-[#2E4B2C]">
                                    <span>女</span>
                                </label>
                            </div>
                            <div id="gender-error" class="text-red-500 text-sm mt-1 hidden" style="font-family: 'Noto Sans SC', sans-serif;">请选择性别</div>
                        </div>
                        
                        <!-- 出生年月日输入 -->
                        <div class="mb-6">
                            <label class="flex items-center text-base font-medium mb-3" style="font-family: 'Noto Sans SC', serif; 
                                          color: #2E4B2C; 
                                          letter-spacing: 0.05em;">
                                <span>出生年月日</span>
                                <span class="text-lg ml-2">📅</span>
                            </label>
                            <input type="date" id="birthdate-input" class="w-full px-4 py-3 rounded-lg border border-solid transition-all duration-300" style="background: rgba(255, 255, 255, 0.9);
                                          border-color: rgba(255, 255, 255, 0.3);
                                          color: #2E4B2C;
                                          font-family: 'Noto Sans SC', sans-serif;
                                          font-size: 1rem;
                                          backdrop-filter: blur(10px);
                                          -webkit-backdrop-filter: blur(10px);">
                            <div id="birthdate-error" class="text-red-500 text-sm mt-1 hidden" style="font-family: 'Noto Sans SC', sans-serif;">请选择出生年月日</div>
                        </div>
                        
                        <!-- 籍贯输入 -->
                        <div class="mb-6">
                            <label class="flex items-center text-base font-medium mb-3" style="font-family: 'Noto Sans SC', serif; 
                                          color: #2E4B2C; 
                                          letter-spacing: 0.05em;">
                                <span>籍贯</span>
                                <span class="text-lg ml-2">🏠</span>
                            </label>
                            <input type="text" id="hometown-input" placeholder="请输入籍贯" class="w-full px-4 py-3 rounded-lg border border-solid transition-all duration-300" style="background: rgba(255, 255, 255, 0.9);
                                          border-color: rgba(255, 255, 255, 0.3);
                                          color: #2E4B2C;
                                          font-family: 'Noto Sans SC', sans-serif;
                                          font-size: 1rem;
                                          backdrop-filter: blur(10px);
                                          -webkit-backdrop-filter: blur(10px);">
                            <div id="hometown-error" class="text-red-500 text-sm mt-1 hidden" style="font-family: 'Noto Sans SC', sans-serif;">请输入籍贯</div>
                        </div>
                        
                        <!-- 出生地输入 -->
                        <div class="mb-8">
                            <label class="flex items-center text-base font-medium mb-3" style="font-family: 'Noto Sans SC', serif; 
                                          color: #2E4B2C; 
                                          letter-spacing: 0.05em;">
                                <span>出生地</span>
                                <span class="text-lg ml-2">📍</span>
                            </label>
                            <input type="text" id="location-input" placeholder="请输入出生地" class="w-full px-4 py-3 rounded-lg border border-solid transition-all duration-300" style="background: rgba(255, 255, 255, 0.9);
                                          border-color: rgba(255, 255, 255, 0.3);
                                          color: #2E4B2C;
                                          font-family: 'Noto Sans SC', sans-serif;
                                          font-size: 1rem;
                                          backdrop-filter: blur(10px);
                                          -webkit-backdrop-filter: blur(10px);">
                            <div id="location-error" class="text-red-500 text-sm mt-1 hidden" style="font-family: 'Noto Sans SC', sans-serif;">请输入出生地</div>
                        </div>
                        
                        <!-- 提交按钮 - 与二级页面相同 -->
                        <button onclick="submitForm()" 
                                class="relative w-full rounded-2xl 
                                       transition-all duration-500 
                                       group
                                       hover:shadow-2xl
                                       hover:scale-[1.02]
                                       active:scale-[0.98]
                                       overflow-hidden" 
                                style="height: 70px; 
                                       background: linear-gradient(135deg, #2E4B2C 0%, #3A5A3A 100%);
                                       border: 1px solid rgba(255, 255, 255, 0.2);
                                       box-shadow: 0 8px 32px rgba(46, 75, 44, 0.35), 0 4px 16px rgba(46, 75, 44, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.15);">
                            <!-- 按钮内容 -->
                            <div class="flex items-center justify-center gap-4 h-full relative z-10">
                                <!-- 白色实心圆圈包围的勾选图标 -->
                                <div class="relative w-12 h-12 rounded-full bg-white flex items-center justify-center" style="box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.08), inset 0 1px 2px rgba(255, 255, 255, 0.9);">
                                    <!-- 墨绿色勾选图标 -->
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="#2E4B2C" style="filter: drop-shadow(0 1px 2px rgba(46, 75, 44, 0.2));">
                                        <path d="M9,16.17L4.83,12L3.41,13.41L9,19L21,7L19.59,5.59L9,16.17Z"></path>
                                    </svg>
                                    <!-- 勾选光晕 -->
                                    <div class="absolute inset-0 rounded-full" style="background: radial-gradient(circle, rgba(46, 75, 44, 0.1) 0%, transparent 70%);"></div>
                                </div>
                                
                                <span style="color: white; font-size: 18px; font-weight: 600; font-family: 'Noto Sans SC', sans-serif; letter-spacing: 0.05em; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);">提交信息</span>
                            </div>
                            
                            <!-- 悬停效果层 - 增强 -->
                            <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-all duration-500" 
                                 style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.08) 50%, transparent 100%); 
                                        box-shadow: inset 0 2px 8px rgba(255, 255, 255, 0.2);
                                        pointer-events: none;"></div>
                            
                            <!-- 光泽扫过效果 -->
                            <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-700 overflow-hidden">
                                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white to-transparent opacity-20 transform -skew-x-12 translate-x-full group-hover:translate-x-full transition-transform duration-1000"></div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 装饰元素 -->
            <div class="text-center mt-8">
                <svg width="100" height="30" viewBox="0 0 100 30">
                    <g fill="none" stroke="#D4AF37" stroke-width="1" opacity="0.3">
                        <path d="M20,15 Q30,10 40,15 T60,15 Q70,10 80,15"></path>
                        <circle cx="30" cy="13" r="1" fill="#D4AF37"></circle>
                        <circle cx="70" cy="13" r="1" fill="#D4AF37"></circle>
                    </g>
                </svg>
            </div>
        </main>
        
        <!-- AI语音对话页面 -->
        <main id="voice-page" class="px-4 page-content relative" style="padding-bottom: 200px;">
            <!-- 顶部标题栏 -->
            <div class="flex items-center justify-start pt-6 pb-4">
                <button onclick="showFormPageFromVoice()" class="flex items-center justify-center text-base px-3 py-2 rounded-full transition-all duration-300 hover:bg-opacity-10 hover:bg-[#2E4B2C]" style="color: #2E4B2C; font-family: 'Noto Sans SC', serif; width: 40px; height: 40px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z"></path>
                    </svg>
                </button>
            </div>
            
            <!-- 页面标题 -->
            <div class="text-center mb-4" style="margin-top: 0px;">
                <div class="text-center">
                    <h2 class="text-3xl font-bold" style="font-size: 32px; font-weight: 700; font-family: 'Noto Sans SC', serif; color: #2E4B2C; line-height: 1.4; letter-spacing: 0.08em; text-shadow: 2px 2px 4px rgba(46, 75, 44, 0.15);">
                        Step 2
                    </h2>
                    <h2 class="text-3xl font-bold mt-2" style="font-size: 32px; font-weight: 700; font-family: 'Noto Sans SC', serif; color: #2E4B2C; line-height: 1.4; letter-spacing: 0.08em; text-shadow: 2px 2px 4px rgba(46, 75, 44, 0.15);">
                        说说你的家族故事
                    </h2>
                </div>
            </div>
            
            <!-- 对话内容区域 -->
            <div id="chat-container" class="overflow-y-auto px-6" style="height: calc(60vh - 40px);">
                    <!-- AI欢迎消息 -->
                    <div class="mb-4 relative z-10">
                        <div class="flex gap-3">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 ai-avatar" style="background: linear-gradient(135deg, #FF6B6B 0%, #4ECDC4 50%, #45B7D1 100%); box-shadow: 0 4px 12px rgba(78, 205, 196, 0.3);">
                                <!-- 美学化的机器人头像 -->
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                                    <!-- 机器人头部 -->
                                    <circle cx="12" cy="8" r="6" fill="white" opacity="0.9"/>
                                    <!-- 眼睛 -->
                                    <circle cx="10" cy="7" r="1.5" fill="#FF6B6B"/>
                                    <circle cx="14" cy="7" r="1.5" fill="#FF6B6B"/>
                                    <!-- 微笑 -->
                                    <path d="M9 10 Q12 12 15 10" stroke="#4ECDC4" stroke-width="1" fill="none" stroke-linecap="round"/>
                                    <!-- 天线 -->
                                    <line x1="12" y1="2" x2="12" y2="4" stroke="white" stroke-width="2" stroke-linecap="round"/>
                                    <circle cx="12" cy="1.5" r="1" fill="#45B7D1"/>
                                </svg>
                            </div>
                            <div class="max-w-[80%] px-4 py-3 rounded-lg" style="background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(212, 175, 55, 0.15);">
                                <p style="color: #2E4B2C; font-family: 'Noto Sans SC', sans-serif; line-height: 1.6;">
                                    请选择下方的故事主题或直接开始讲述你想要记录的家族故事吧
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

            <!-- 录音和话题功能按钮区域 - 放在最底部 -->
            <div class="absolute bottom-0 left-0 right-0 bg-white border-t border-solid py-3 px-6 z-30" 
                 style="border-top-color: rgba(124, 179, 66, 0.1); 
                        background: rgba(255, 255, 255, 0.95);
                        backdrop-filter: blur(10px);
                        min-height: 120px;">
                <div class="flex flex-col items-center">
                    <div class="flex items-center gap-4 mb-2">
                        <span id="voice-status" class="text-xs text-gray-600">点击开始录音</span>
                        <span id="voice-time" class="text-xs font-mono text-gray-700 font-semibold">00:00</span>
                    </div>
                    <div class="flex items-center justify-center gap-8">
                        <!-- 话题选择按钮 -->
                        <div class="relative" id="topic-menu-container" style="z-index: 40;">
                            <button onclick="toggleTopicMenu()" class="w-16 h-16 rounded-full flex items-center justify-center transition-all duration-300 hover:scale-105 active:scale-95"
                                    style="background: linear-gradient(135deg, #FF9800 0%, #FFC107 100%);
                                           box-shadow: 0 12px 32px rgba(255, 152, 0, 0.5);
                                           border: 4px solid rgba(255, 193, 7, 0.5);
                                           display: flex !important;
                                           visibility: visible !important;
                                           position: relative;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                                    <path d="M11,18H13V16H11V18M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,6A4,4 0 0,0 8,10H10A2,2 0 0,1 12,8A2,2 0 0,1 14,10C14,12 11,11.75 11,15H13C13,12.75 16,12.5 16,10A4,4 0 0,0 12,6Z"/>
                                </svg>
                            </button>
                            
                            <!-- 话题选择菜单 -->
                            <div id="topic-menu" class="absolute bottom-14 left-0 w-64 bg-white rounded-xl shadow-2xl border hidden overflow-hidden z-50" 
                                 style="border-color: rgba(212, 175, 55, 0.2); transform-origin: bottom left;">
                                
                                <!-- 菜单标题 -->
                                <div class="px-4 py-3 border-b" style="background: linear-gradient(135deg, #FF9800 0%, #FFC107 100%); color: white; border-color: rgba(255, 193, 7, 0.3);">
                                    <h3 class="font-semibold text-base" style="font-family: 'Noto Sans SC', sans-serif;">选择故事主题</h3>
                                </div>
                                
                                <!-- 菜单内容 - 可滚动 -->
                                <div class="max-h-64 overflow-y-auto">
                                    <!-- 家族历史 -->
                                    <div class="border-b" style="border-color: rgba(212, 175, 55, 0.1);">
                                        <button onclick="selectStoryTopic('家族历史')" class="w-full px-4 py-3 text-left hover:bg-gray-50 transition-colors flex items-center gap-3">
                                            <div class="w-8 h-8 rounded-full flex items-center justify-center" style="background: linear-gradient(135deg, #FF6B6B 0%, #4ECDC4 50%, #45B7D1 100%);">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
                                                    <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8Z"/>
                                                </svg>
                                            </div>
                                            <div>
                                                <div class="font-medium text-gray-800" style="font-family: 'Noto Sans SC', sans-serif;">家族历史</div>
                                                <div class="text-xs text-gray-500">家族起源、发展历程</div>
                                            </div>
                                        </button>
                                    </div>
                                    
                                    <!-- 人物故事 -->
                                    <div class="border-b" style="border-color: rgba(212, 175, 55, 0.1);">
                                        <button onclick="selectStoryTopic('人物故事')" class="w-full px-4 py-3 text-left hover:bg-gray-50 transition-colors flex items-center gap-3">
                                            <div class="w-8 h-8 rounded-full flex items-center justify-center" style="background: linear-gradient(135deg, #D32F2F 0%, #F44336 100%);">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
                                                    <path d="M12,5.5A3.5,3.5 0 0,1 15.5,9A3.5,3.5 0 0,1 12,12.5A3.5,3.5 0 0,1 8.5,9A3.5,3.5 0 0,1 12,5.5M5,8C5.56,8 6.08,8.15 6.53,8.42C6.38,9.85 6.8,11.27 7.66,12.38C7.16,13.34 6.16,14 5,14A3,3 0 0,1 2,11A3,3 0 0,1 5,8M19,8A3,3 0 0,1 22,11A3,3 0 0,1 19,14C17.84,14 16.84,13.34 16.34,12.38C17.2,11.27 17.62,9.85 17.47,8.42C17.92,8.15 18.44,8 19,8M5.5,18.25C5.5,16.18 8.41,14.5 12,14.5C15.59,14.5 18.5,16.18 18.5,18.25V20H5.5V18.25M0,20V18.5C0,17.11 1.89,15.94 4.45,15.6C3.86,16.28 3.5,17.22 3.5,18.25V20H0M24,20H20.5V18.25C20.5,17.22 20.14,16.28 19.55,15.6C22.11,15.94 24,17.11 24,18.5V20Z"/>
                                                </svg>
                                            </div>
                                            <div>
                                                <div class="font-medium text-gray-800" style="font-family: 'Noto Sans SC', sans-serif;">人物故事</div>
                                                <div class="text-xs text-gray-500">家族成员生平事迹</div>
                                            </div>
                                        </button>
                                    </div>
                                    
                                    <!-- 传统习俗 -->
                                    <div class="border-b" style="border-color: rgba(212, 175, 55, 0.1);">
                                        <button onclick="selectStoryTopic('传统习俗')" class="w-full px-4 py-3 text-left hover:bg-gray-50 transition-colors flex items-center gap-3">
                                            <div class="w-8 h-8 rounded-full flex items-center justify-center" style="background: linear-gradient(135deg, #FF9800 0%, #FFC107 100%);">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
                                                    <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
                                                </svg>
                                            </div>
                                            <div>
                                                <div class="font-medium text-gray-800" style="font-family: 'Noto Sans SC', sans-serif;">传统习俗</div>
                                                <div class="text-xs text-gray-500">家族传统、节日习俗</div>
                                            </div>
                                        </button>
                                    </div>
                                    
                                    <!-- 珍贵回忆 -->
                                    <div class="border-b" style="border-color: rgba(212, 175, 55, 0.1);">
                                        <button onclick="selectStoryTopic('珍贵回忆')" class="w-full px-4 py-3 text-left hover:bg-gray-50 transition-colors flex items-center gap-3">
                                            <div class="w-8 h-8 rounded-full flex items-center justify-center" style="background: linear-gradient(135deg, #9C27B0 0%, #E91E63 100%);">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
                                                    <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8Z"/>
                                                </svg>
                                            </div>
                                            <div>
                                                <div class="font-medium text-gray-800" style="font-family: 'Noto Sans SC', sans-serif;">珍贵回忆</div>
                                                <div class="text-xs text-gray-500">难忘经历、感人故事</div>
                                            </div>
                                        </button>
                                    </div>
                                    
                                    <!-- 家族成就 -->
                                    <div class="border-b" style="border-color: rgba(212, 175, 55, 0.1);">
                                        <button onclick="selectStoryTopic('家族成就')" class="w-full px-4 py-3 text-left hover:bg-gray-50 transition-colors flex items-center gap-3">
                                            <div class="w-8 h-8 rounded-full flex items-center justify-center" style="background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
                                                    <path d="M5,16L3,5L8.5,10L12,4L15.5,10L21,5L19,16H5M19,19C19,20.1 18.1,21 17,21H7C5.9,21 5,20.1 5,19V18H19V19Z"/>
                                                </svg>
                                            </div>
                                            <div>
                                                <div class="font-medium text-gray-800" style="font-family: 'Noto Sans SC', sans-serif;">家族成就</div>
                                                <div class="text-xs text-gray-500">事业发展、重要成就</div>
                                            </div>
                                        </button>
                                    </div>
                                    
                                    <!-- 家训家规 -->
                                    <div>
                                        <button onclick="selectStoryTopic('家训家规')" class="w-full px-4 py-3 text-left hover:bg-gray-50 transition-colors flex items-center gap-3">
                                            <div class="w-8 h-8 rounded-full flex items-center justify-center" style="background: linear-gradient(135deg, #795548 0%, #A1887F 100%);">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
                                                    <path d="M9,4V7H14V4H9M16,2V7H20V9H4V7H8V2H16M16,9V22H8V9H16M18,9H22V22H20V11H18V9Z"/>
                                                </svg>
                                            </div>
                                            <div>
                                                <div class="font-medium text-gray-800" style="font-family: 'Noto Sans SC', sans-serif;">家训家规</div>
                                                <div class="text-xs text-gray-500">家族传承、价值观念</div>
                                            </div>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 录音按钮 -->
                        <button onclick="toggleVoiceRecording()" id="voice-button" class="w-20 h-20 rounded-full flex items-center justify-center transition-all duration-300 hover:scale-105 active:scale-95 relative z-50" style="background: linear-gradient(135deg, #2E4B2C 0%, #3A5A3A 100%);
                                       box-shadow: 0 16px 40px rgba(46, 75, 44, 0.6);
                                       border: 5px solid rgba(212, 175, 55, 0.6);
                                       display: flex !important;
                                       visibility: visible !important;
                                       min-width: 80px;
                                       min-height: 80px;
                                       position: relative;">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="white" id="voice-icon">
                                <path d="M12,14A3,3 0 0,0 15,11V5A3,3 0 0,0 12,2A3,3 0 0,0 9,5V11A3,3 0 0,0 12,14M20,11C20,14.53 17.39,17.44 14,17.93V21H10V17.93C6.61,17.44 4,14.53 4,11H6A6,6 0 0,0 12,17A6,6 0 0,0 18,11H20Z"></path>
                            </svg>
                        </button>
                        
                        <!-- 下一步箭头按钮 -->
                        <button onclick="goToNextStep()" class="w-16 h-16 rounded-full flex items-center justify-center transition-all duration-300 hover:scale-105 active:scale-95 relative z-50" style="background: linear-gradient(135deg, #FF9800 0%, #FFC107 100%);
                                       box-shadow: 0 12px 32px rgba(255, 152, 0, 0.5);
                                       border: 4px solid rgba(255, 193, 7, 0.5);
                                       display: flex !important;
                                       visibility: visible !important;
                                       min-width: 64px;
                                       min-height: 64px;
                                       position: relative;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                                <path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 文本输入框区域 - 放在按钮上方，确保不被遮挡 -->
            <div class="absolute left-0 right-0 px-6 z-50" 
                 style="bottom: 130px;">
                <div class="flex items-center gap-2">
                    <input type="text" 
                           id="answer-input" 
                           placeholder="输入您的回答..." 
                           class="flex-1 px-4 py-3 rounded-xl border border-solid transition-all duration-300"
                           style="background: rgba(255, 255, 255, 0.98);
                                  border-color: rgba(46, 75, 44, 0.3);
                                  color: #2E4B2C;
                                  font-family: 'Noto Sans SC', sans-serif;
                                  font-size: 1rem;
                                  backdrop-filter: blur(10px);
                                  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
                    <button onclick="submitTextAnswer()" 
                            class="px-6 py-3 rounded-xl transition-all duration-300 hover:scale-105 active:scale-95 flex-shrink-0"
                            style="background: linear-gradient(135deg, #2E4B2C 0%, #3A5A3A 100%);
                                   color: white;
                                   font-family: 'Noto Sans SC', sans-serif;
                                   font-weight: 600;
                                   box-shadow: 0 4px 12px rgba(46, 75, 44, 0.4);">
                        发送
                    </button>
                </div>
            </div>
        </main>
        
        <!-- 报告展示页面 -->
        <main id="report-page" class="px-4 page-content relative" style="padding-bottom: 100px;">
            <!-- 返回按钮 -->
            <div class="flex items-center justify-start pt-6 pb-4">
                <button onclick="showHomePage()" class="flex items-center justify-center text-base px-3 py-2 rounded-full transition-all duration-300 hover:bg-opacity-10 hover:bg-[#2E4B2C]" style="color: #2E4B2C; font-family: 'Noto Sans SC', serif; width: 40px; height: 40px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z"></path>
                    </svg>
                </button>
            </div>
            
            <!-- 页面标题 -->
            <div class="text-center mb-6" style="margin-top: 0px;">
                <div class="text-center">
                    <h2 class="text-3xl font-bold" style="font-size: 32px; font-weight: 700; font-family: 'Noto Sans SC', serif; color: #2E4B2C; line-height: 1.4; letter-spacing: 0.08em; text-shadow: 2px 2px 4px rgba(46, 75, 44, 0.15);">
                        家族寻根报告
                    </h2>
                </div>
            </div>
            
            <!-- 报告内容区域 -->
            <div id="report-container" class="overflow-y-auto px-4" style="height: calc(100vh - 200px); max-height: 600px;">
                <!-- 加载提示 -->
                <div id="report-loading" class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-[#2E4B2C]" style="border-color: #2E4B2C;"></div>
                    <p class="mt-4" style="color: #2E4B2C; font-family: 'Noto Sans SC', sans-serif;">正在生成报告，请耐心等待...</p>
                </div>
                
                <!-- 报告内容 -->
                <div id="report-content" class="hidden">
                    <!-- 报告标题 -->
                    <div class="mb-6 text-center">
                        <h3 id="report-title" class="text-2xl font-bold mb-2" style="font-family: 'Noto Sans SC', serif; color: #2E4B2C;"></h3>
                        <p id="report-summary" class="text-sm text-gray-600" style="font-family: 'Noto Sans SC', sans-serif;"></p>
                    </div>
                    
                    <!-- 报告正文 -->
                    <div id="report-text" class="prose prose-sm max-w-none" style="font-family: 'Noto Sans SC', sans-serif; color: #2E4B2C; line-height: 1.8;">
                        <!-- 报告内容将在这里显示 -->
                    </div>
                </div>
                
                <!-- 错误提示 -->
                <div id="report-error" class="hidden text-center py-8">
                    <p class="text-red-500 mb-4" style="font-family: 'Noto Sans SC', sans-serif;">报告生成失败，请重试</p>
                    <button onclick="retryGenerateReport()" class="px-6 py-3 rounded-xl transition-all duration-300 hover:scale-105 active:scale-95" style="background: linear-gradient(135deg, #2E4B2C 0%, #3A5A3A 100%); color: white; font-family: 'Noto Sans SC', sans-serif; font-weight: 600;">
                        重新生成
                    </button>
                </div>
            </div>
            
            <!-- 底部操作按钮 -->
            <div class="absolute bottom-0 left-0 right-0 bg-white border-t border-solid py-4 px-6 z-40" 
                 style="border-top-color: rgba(124, 179, 66, 0.1); 
                        background: rgba(255, 255, 255, 0.95);
                        backdrop-filter: blur(10px);">
                <div class="flex items-center justify-center gap-4">
                    <button onclick="saveReportAsArchive()" class="px-6 py-3 rounded-xl transition-all duration-300 hover:scale-105 active:scale-95" style="background: linear-gradient(135deg, #2E4B2C 0%, #3A5A3A 100%); color: white; font-family: 'Noto Sans SC', sans-serif; font-weight: 600; box-shadow: 0 4px 12px rgba(46, 75, 44, 0.3);">
                        保存为档案
                    </button>
                    <button onclick="shareReport()" class="px-6 py-3 rounded-xl transition-all duration-300 hover:scale-105 active:scale-95 border-2" style="border-color: #2E4B2C; color: #2E4B2C; font-family: 'Noto Sans SC', sans-serif; font-weight: 600;">
                        分享报告
                    </button>
                </div>
            </div>
        </main>
        
        </div> <!-- 关闭页面容器 -->
        
    </div>

    </div>
    
    <script>
        // ==================== API配置 ====================
        // 根据运行环境自动选择API地址
        function getApiBaseUrl() {
            const hostname = window.location.hostname;
            const port = window.location.port;
            
            // 如果是在Docker中运行（通过nginx代理），使用相对路径
            if (hostname === 'localhost' && port === '3000') {
                // 通过nginx代理访问后端
                return '';
            } else if (hostname === 'localhost' || hostname === '127.0.0.1') {
                // 本地开发，直接访问后端
                return 'http://localhost:8000';
            } else {
                // 生产环境，使用相对路径（通过nginx代理）
                return '';
            }
        }
        
        const API_BASE_URL = getApiBaseUrl();
        console.log('API Base URL:', API_BASE_URL || '使用相对路径（通过nginx代理）');
        
        // 全局状态管理
        window.appState = {
            sessionId: null,
            currentQuestion: null,
            isProcessing: false
        };
        
        // ==================== API调用函数 ====================
        
        /**
         * 创建会话
         */
        async function createSession(userData) {
            try {
                const response = await fetch(`${API_BASE_URL}/user/input`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: userData.name,
                        birth_date: userData.birthdate || null,
                        birth_place: userData.hometown || null,
                        current_location: userData.location || null
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                window.appState.sessionId = result.session_id;
                console.log('会话创建成功:', window.appState.sessionId);
                return result.session_id;
            } catch (error) {
                console.error('创建会话失败:', error);
                throw error;
            }
        }
        
        /**
         * 获取初始问题
         */
        async function getInitialQuestion(sessionId) {
            try {
                const response = await fetch(`${API_BASE_URL}/ai/question/${sessionId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                window.appState.currentQuestion = result.question;
                return result.question;
            } catch (error) {
                console.error('获取问题失败:', error);
                throw error;
            }
        }
        
        /**
         * 提交回答
         */
        async function submitAnswer(sessionId, answer) {
            try {
                const response = await fetch(`${API_BASE_URL}/ai/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        answer: answer
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                window.appState.currentQuestion = result.question;
                return result;
            } catch (error) {
                console.error('提交回答失败:', error);
                throw error;
            }
        }
        
        /**
         * 搜索家族历史
         */
        async function searchFamily(sessionId) {
            try {
                const response = await fetch(`${API_BASE_URL}/search/family?session_id=${sessionId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('搜索家族失败:', error);
                throw error;
            }
        }
        
        /**
         * 生成报告
         */
        async function generateReport(sessionId) {
            try {
                // 设置更长的超时时间（5分钟）
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 300000); // 5分钟
                
                const response = await fetch(`${API_BASE_URL}/generate/report`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: `HTTP error! status: ${response.status}` }));
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                // 确保返回的数据结构正确
                if (!result.report && result) {
                    // 如果返回的就是报告数据本身
                    return { report: result };
                }
                
                return result;
            } catch (error) {
                console.error('生成报告失败:', error);
                // 不直接抛出错误，让调用者处理
                throw error;
            }
        }
        
        /**
         * 保存档案
         */
        async function archiveSession(sessionId, title, notes = '') {
            try {
                const response = await fetch(`${API_BASE_URL}/session/${sessionId}/archive`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: title || `${window.familyInfo?.姓名 || '用户'}的家族寻根档案`,
                        notes: notes
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('保存档案失败:', error);
                throw error;
            }
        }
        
        /**
         * 获取档案列表
         */
        async function getArchives(archived = true) {
            try {
                const response = await fetch(`${API_BASE_URL}/session/list?archived=${archived}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                return result.sessions || [];
            } catch (error) {
                console.error('获取档案列表失败:', error);
                throw error;
            }
        }
        
        /**
         * 获取会话详情
         */
        async function getSession(sessionId) {
            try {
                const response = await fetch(`${API_BASE_URL}/session/${sessionId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                return result.session;
            } catch (error) {
                console.error('获取会话详情失败:', error);
                throw error;
            }
        }
        
        /**
         * 生成图片
         */
        async function generateImages(sessionId, numImages = 1) {
            try {
                const response = await fetch(`${API_BASE_URL}/generate/images`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        num_images: numImages,
                        size: '2K'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('生成图片失败:', error);
                throw error;
            }
        }
        
        // ==================== 工具函数 ====================
        
        /**
         * 显示加载提示
         */
        function showLoading(message = '处理中...') {
            // 可以在这里添加全局加载提示
            console.log('Loading:', message);
        }
        
        /**
         * 显示错误提示
         */
        function showError(message) {
            alert('错误: ' + message);
            console.error('Error:', message);
        }
        
        /**
         * 显示成功提示
         */
        function showSuccess(message) {
            console.log('Success:', message);
            // 可以在这里添加全局成功提示
        }
        
        // ==================== 页面功能函数 ====================
        
        // 全局页面切换函数
        function switchPage(targetPageId) {
            console.log('switchPage被调用，目标页面:', targetPageId);
            
            // 隐藏所有页面
            const allPages = document.querySelectorAll('.page-content');
            console.log('找到的页面数量:', allPages.length);
            allPages.forEach(page => {
                console.log('隐藏页面:', page.id);
                page.classList.remove('active');
            });
            
            // 显示目标页面
            const targetPage = document.getElementById(targetPageId);
            if (targetPage) {
                console.log('显示目标页面:', targetPageId);
                targetPage.classList.add('active');
                console.log('页面切换完成:', targetPageId);
            } else {
                console.error('目标页面元素未找到:', targetPageId);
                alert('页面切换失败：未找到目标页面');
            }
        }
        
        function showFormPage() {
            console.log('showFormPage被调用');
            switchPage('form-page');
        }
        
        function showMainPage() {
            switchPage('home-page');
        }
        
        function showWelcomePage() {
            switchPage('welcome-page');
        }

        function showHomePage() {
            switchPage('home-page');
        }
        
        function showFormPageFromVoice() {
            switchPage('form-page');
        }
        
        function showFormPageFromHome() {
            switchPage('form-page');
        }
        
        // 表单验证函数
        function validateForm() {
            let isValid = true;
            
            // 隐藏所有错误提示
            hideAllErrors();
            
            // 获取输入框
            const nameInput = document.getElementById('name-input');
            const birthdateInput = document.getElementById('birthdate-input');
            const hometownInput = document.getElementById('hometown-input');
            const locationInput = document.getElementById('location-input');
            const genderInput = document.querySelector('input[name="gender"]:checked');
            
            // 验证姓名
            const name = nameInput.value.trim();
            if (!name) {
                showError('name-error', '姓名不能为空');
                isValid = false;
            } else if (name.length < 2) {
                showError('name-error', '姓名至少需要2个字符');
                isValid = false;
            } else if (name.length > 20) {
                showError('name-error', '姓名不能超过20个字符');
                isValid = false;
            } else if (!/^[\u4e00-\u9fa5a-zA-Z\s]+$/.test(name)) {
                showError('name-error', '姓名只能包含中文、英文和空格');
                isValid = false;
            }
            
            // 验证性别
            if (!genderInput) {
                showError('gender-error', '请选择性别');
                isValid = false;
            }
            
            // 验证出生年月日
            const birthdate = birthdateInput.value.trim();
            if (!birthdate) {
                showError('birthdate-error', '请选择出生年月日');
                isValid = false;
            } else {
                const birthDate = new Date(birthdate);
                const today = new Date();
                const age = today.getFullYear() - birthDate.getFullYear();
                
                if (birthDate > today) {
                    showError('birthdate-error', '出生日期不能是未来时间');
                    isValid = false;
                } else if (age > 120) {
                    showError('birthdate-error', '出生日期不合理');
                    isValid = false;
                } else if (age < 0) {
                    showError('birthdate-error', '出生日期格式不正确');
                    isValid = false;
                }
            }
            
            // 验证籍贯
            const hometown = hometownInput.value.trim();
            if (!hometown) {
                showError('hometown-error', '请输入籍贯');
                isValid = false;
            } else if (hometown.length < 2) {
                showError('hometown-error', '籍贯至少需要2个字符');
                isValid = false;
            } else if (hometown.length > 30) {
                showError('hometown-error', '籍贯不能超过30个字符');
                isValid = false;
            }
            
            // 验证出生地
            const location = locationInput.value.trim();
            if (!location) {
                showError('location-error', '请输入出生地');
                isValid = false;
            } else if (location.length < 2) {
                showError('location-error', '出生地至少需要2个字符');
                isValid = false;
            } else if (location.length > 30) {
                showError('location-error', '出生地不能超过30个字符');
                isValid = false;
            }
            
            // 不再显示整体错误信息，只显示具体字段错误
            
            return isValid;
        }
        
        // 显示错误信息
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.classList.remove('hidden');
            }
        }
        
        // 隐藏所有错误信息
        function hideAllErrors() {
            const errorElements = document.querySelectorAll('[id$="-error"]');
            errorElements.forEach(element => {
                element.classList.add('hidden');
            });
        }
        
        // 输入框焦点事件：清除错误
        function setupInputValidation() {
            const inputs = ['name-input', 'birthdate-input', 'hometown-input', 'location-input'];
            inputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('input', () => {
                        const errorId = inputId.replace('-input', '-error');
                        const errorElement = document.getElementById(errorId);
                        if (errorElement) {
                            errorElement.classList.add('hidden');
                        }

                    });
                }
            });
            
            // 性别选择事件
            const genderInputs = document.querySelectorAll('input[name="gender"]');
            genderInputs.forEach(input => {
                input.addEventListener('change', () => {
                    const errorElement = document.getElementById('gender-error');
                    if (errorElement) {
                        errorElement.classList.add('hidden');
                    }

                });
            });
        }
        
        // 表单提交函数 - 已连接后端API
        async function submitForm() {
            console.log('submitForm函数被调用');
            
            // 检查输入框是否存在
            const nameInput = document.getElementById('name-input');
            const birthdateInput = document.getElementById('birthdate-input');
            const hometownInput = document.getElementById('hometown-input');
            const locationInput = document.getElementById('location-input');
            
            if (!nameInput || !birthdateInput || !hometownInput || !locationInput) {
                console.error('某个输入框元素未找到');
                return;
            }
            
            // 验证表单
            if (!validateForm()) {
                return;
            }
            
            const name = nameInput.value.trim();
            const birthdate = birthdateInput.value.trim();
            const hometown = hometownInput.value.trim();
            const location = locationInput.value.trim();
            
            // 获取性别选择
            const genderInput = document.querySelector('input[name="gender"]:checked');
            const gender = genderInput ? genderInput.value : '';
            
            console.log('获取的值：', { name, gender, birthdate, hometown, location });
            
            // 保存信息到全局变量
            window.familyInfo = {
                姓名: name,
                性别: gender === 'male' ? '男' : (gender === 'female' ? '女' : ''),
                出生年月日: birthdate,
                籍贯: hometown,
                出生地: location
            };
            
            // 显示加载提示
            showLoading('正在创建会话...');
            
            try {
                // 调用后端API创建会话
                const userData = {
                    name: name,
                    birthdate: birthdate || null,
                    hometown: hometown || null,
                    location: location || null
                };
                
                const sessionId = await createSession(userData);
                window.appState.sessionId = sessionId;
                
                console.log('会话创建成功，sessionId:', sessionId);
                
                // 获取初始问题
                showLoading('正在获取初始问题...');
                const initialQuestion = await getInitialQuestion(sessionId);
                
                console.log('初始问题:', initialQuestion);
                
                // 清空表单
                nameInput.value = '';
                birthdateInput.value = '';
                hometownInput.value = '';
                locationInput.value = '';
                
                // 清空性别选择
                if (genderInput) {
                    genderInput.checked = false;
                }
                
                // 隐藏所有错误信息
                hideAllErrors();
                
                // 跳转到语音页面
                console.log('表单验证通过，正在跳转到AI语音页面...');
                switchPage('voice-page');
                
                // 更新语音页面中的姓名信息
                setTimeout(() => {
                    const memberNameElements = [
                        document.getElementById('member-name'),
                        document.getElementById('member-name-2')
                    ];
                    memberNameElements.forEach((el, index) => {
                        console.log(`更新姓名元素${index + 1}:`, el);
                        if (el && window.familyInfo) {
                            el.textContent = window.familyInfo.姓名;
                            console.log(`姓名已更新为: ${window.familyInfo.姓名}`);
                        }
                    });
                    
                    // 显示初始问题
                    if (initialQuestion) {
                        setTimeout(() => {
                            addAIMessage(initialQuestion);
                        }, 500);
                    }
                    
                    console.log('AI语音页面初始化完成');
                }, 200);
                
            } catch (error) {
                console.error('提交表单失败:', error);
                showError('创建会话失败，请重试');
            }
        }
        
        // 语音录制相关变量
        let isRecording = false;
        let recordingStartTime = null;
        let recordingTimer = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let audioStream = null;
        
        // 初始化录音功能
        async function initRecording() {
            try {
                audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                console.log('麦克风权限已获取');
            } catch (error) {
                console.error('无法获取麦克风权限:', error);
                addAIMessage('无法访问麦克风，请检查浏览器权限设置');
            }
        }
        
        // 切换语音录制状态
        async function toggleVoiceRecording() {
            const voiceButton = document.getElementById('voice-button');
            const voiceIcon = document.getElementById('voice-icon');
            const voiceStatus = document.getElementById('voice-status');
            const voiceTime = document.getElementById('voice-time');
            const chatContainer = document.getElementById('chat-container');
            
            if (!isRecording) {
                // 开始录音
                try {
                    if (!audioStream) {
                        await initRecording();
                    }
                    
                    audioChunks = [];
                    mediaRecorder = new MediaRecorder(audioStream);
                    
                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        console.log('录音已完成，文件大小:', audioBlob.size, 'bytes');
                        
                        // 这里可以上传音频文件或进行其他处理
                        // uploadAudio(audioBlob);
                    };
                    
                    mediaRecorder.start();
                    isRecording = true;
                    recordingStartTime = Date.now();
                    
                    // 更新UI状态
                    voiceButton.style.background = 'linear-gradient(135deg, #D32F2F 0%, #F44336 100%)';
                    voiceIcon.innerHTML = '<path d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z"/>';
                    voiceStatus.textContent = '录音中...';
                    
                    // 开始计时
                    recordingTimer = setInterval(() => {
                        const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                        const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                        const seconds = (elapsed % 60).toString().padStart(2, '0');
                        voiceTime.textContent = `${minutes}:${seconds}`;
                    }, 1000);
                    
                    // 添加用户录音提示消息
                    const userMessage = document.createElement('div');
                    userMessage.className = 'mb-4';
                    userMessage.innerHTML = `
                        <div class="flex gap-3 justify-end">
                            <div class="max-w-[80%] px-4 py-3 rounded-lg"
                                 style="background: linear-gradient(135deg, #2E4B2C 0%, #3A5A3A 100%);
                                            color: white;
                                            font-family: 'Noto Sans SC', sans-serif;
                                            line-height: 1.6;">
                                <div class="flex items-center gap-2">
                                    <div class="w-2 h-2 rounded-full bg-white animate-pulse"></div>
                                    <span>正在录音中...</span>
                                </div>
                            </div>
                        </div>
                    `;
                    chatContainer.appendChild(userMessage);
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    
                } catch (error) {
                    console.error('开始录音失败:', error);
                    addAIMessage('录音失败，请检查麦克风权限');
                }
                
            } else {
                // 停止录音
                try {
                    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                        mediaRecorder.stop();
                    }
                    
                    isRecording = false;
                    clearInterval(recordingTimer);
                    
                    // 更新UI状态
                    voiceButton.style.background = 'linear-gradient(135deg, #2E4B2C 0%, #3A5A3A 100%)';
                    voiceIcon.innerHTML = '<path d="M12,14A3,3 0 0,0 15,11V5A3,3 0 0,0 12,2A3,3 0 0,0 9,5V11A3,3 0 0,0 12,14M20,11C20,14.53 17.39,17.44 14,17.93V21H10V17.93C6.61,17.44 4,14.53 4,11H6A5,5 0 0,0 12,16A5,5 0 0,0 18,11H20Z"/>';
                    voiceStatus.textContent = '点击开始录音';
                    
                    const finalTime = voiceTime.textContent;
                    
                    // 延迟重置时间显示
                    setTimeout(() => {
                        voiceTime.textContent = '00:00';
                    }, 3000);
                    
                    // 更新最后的用户消息
                    const lastMessage = chatContainer.querySelector('.justify-end .px-4');
                    if (lastMessage) {
                        lastMessage.innerHTML = `
                            <div class="flex items-center gap-2 mb-2">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12,14A3,3 0 0,0 15,11V5A3,3 0 0,0 12,2A3,3 0 0,0 9,5V11A3,3 0 0,0 12,14M20,11C20,14.53 17.39,17.44 14,17.93V21H10V17.93C6.61,17.44 4,14.53 4,11H6A5,5 0 0,0 12,16A5,5 0 0,0 18,11H20Z"/>
                                </svg>
                                <span>语音录音已结束</span>
                            </div>
                            <div class="text-sm opacity-80" style="color: #E0E0E0;">
                                录音时长：${finalTime}
                            </div>
                        `;
                    }
                    
                    // 处理录音完成 - 暂时提示用户输入文本
                    setTimeout(() => {
                        addAIMessage('录音已完成！请使用下方的文本输入框输入您的回答，或继续录音。');
                    }, 1000);
                    
                } catch (error) {
                    console.error('停止录音失败:', error);
                }
            }
        }
        
        // 提交文本答案
        async function submitTextAnswer() {
            const answerInput = document.getElementById('answer-input');
            if (!answerInput) {
                console.error('答案输入框未找到');
                return;
            }
            
            const answer = answerInput.value.trim();
            if (!answer) {
                showError('请输入您的回答');
                return;
            }
            
            if (!window.appState.sessionId) {
                showError('会话未创建，请先填写表单');
                return;
            }
            
            // 显示用户消息
            const chatContainer = document.getElementById('chat-container');
            const userMessage = document.createElement('div');
            userMessage.className = 'mb-4';
            userMessage.innerHTML = `
                <div class="flex gap-3 justify-end">
                    <div class="max-w-[80%] px-4 py-3 rounded-lg"
                         style="background: linear-gradient(135deg, #2E4B2C 0%, #3A5A3A 100%);
                                color: white;
                                font-family: 'Noto Sans SC', sans-serif;
                                line-height: 1.6;">
                        ${answer}
                    </div>
                </div>
            `;
            chatContainer.appendChild(userMessage);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // 清空输入框
            answerInput.value = '';
            
            // 显示加载提示
            addAIMessage('正在处理您的回答...');
            
            try {
                // 提交答案到后端
                const result = await submitAnswer(window.appState.sessionId, answer);
                
                if (result.status === 'complete') {
                    // 对话完成
                    addAIMessage('信息收集完成！正在为您搜索家族历史...');
                    
                // 自动触发搜索
                setTimeout(async () => {
                    try {
                        addAIMessage('搜索中，这可能需要几分钟，请耐心等待...');
                        await searchFamily(window.appState.sessionId);
                        addAIMessage('搜索完成！正在生成报告...');
                        
                            // 自动生成报告
                            setTimeout(async () => {
                                try {
                                    // 跳转到报告页面并显示加载状态
                                    switchPage('report-page');
                                    showReportLoading();
                                    
                                    const reportResult = await generateReport(window.appState.sessionId);
                                    
                                    // 确保报告数据存在
                                    if (reportResult && reportResult.report) {
                                        // 显示报告内容
                                        displayReport(reportResult.report);
                                        
                                        // 自动保存档案
                                        setTimeout(async () => {
                                            try {
                                                const archiveTitle = `${window.familyInfo?.姓名 || '用户'}的家族寻根档案`;
                                                await archiveSession(window.appState.sessionId, archiveTitle, '自动保存的寻根档案');
                                                showSuccess('档案已自动保存！');
                                            } catch (error) {
                                                console.error('保存档案失败:', error);
                                                // 不显示错误，用户可以手动保存
                                            }
                                        }, 1000);
                                    } else {
                                        // 即使报告生成失败，也显示一个基本报告
                                        logger.warning('Report result is empty, showing fallback report');
                                        const fallbackReport = {
                                            title: `${window.familyInfo?.姓名 || '用户'}家族历史报告`,
                                            summary: '基于您提供的信息生成的家族历史报告',
                                            report_text: `亲爱的${window.familyInfo?.姓名 || '用户'}：

感谢您参与这次寻根之旅。虽然报告生成过程中遇到了一些技术问题，但我们已为您保存了所有收集到的信息。

**您提供的信息：**
${window.familyInfo ? JSON.stringify(window.familyInfo, null, 2) : '（信息较少，建议继续补充）'}

**下一步建议：**
1. 继续补充家族信息，特别是祖籍、祖父姓名等关键信息
2. 查看搜索到的历史大家族信息
3. 如有需要，可以重新生成报告

感谢您的参与！`
                                        };
                                        displayReport(fallbackReport);
                                    }
                                } catch (error) {
                                    console.error('生成报告失败:', error);
                                    // 即使出错，也显示一个基本报告
                                    const errorReport = {
                                        title: `${window.familyInfo?.姓名 || '用户'}家族历史报告`,
                                        summary: '报告生成遇到问题，但已保存您的信息',
                                        report_text: `亲爱的${window.familyInfo?.姓名 || '用户'}：

感谢您参与这次寻根之旅。报告生成过程中遇到了技术问题：${error.message || '未知错误'}。

**您提供的信息已保存：**
${window.familyInfo ? JSON.stringify(window.familyInfo, null, 2) : '（信息较少）'}

**建议：**
1. 请稍后重试生成报告
2. 或联系技术支持获取帮助

感谢您的参与！`
                                    };
                                    displayReport(errorReport);
                                }
                            }, 1000);
                    } catch (error) {
                        console.error('搜索失败:', error);
                        addAIMessage('搜索失败，但您可以继续使用其他功能。');
                    }
                }, 1000);
                } else if (result.question) {
                    // 显示下一个问题
                    setTimeout(() => {
                        addAIMessage(result.question);
                    }, 500);
                }
            } catch (error) {
                console.error('提交答案失败:', error);
                showError('提交失败，请重试');
                addAIMessage('提交失败，请检查网络连接后重试。');
            }
        }
        
        // 下一步功能 - 已连接后端
        async function goToNextStep() {
            if (!window.appState.sessionId) {
                showError('会话未创建');
                return;
            }
            
            // 添加AI消息提示
            addAIMessage('正在进入下一步...');
            
            try {
                // 如果还没有搜索，先搜索
                addAIMessage('正在搜索家族历史，这可能需要几分钟，请耐心等待...');
                await searchFamily(window.appState.sessionId);
                
                // 生成报告
                addAIMessage('搜索完成，正在生成报告...');
                const reportResult = await generateReport(window.appState.sessionId);
                
                // 跳转到报告页面
                switchPage('report-page');
                showReportLoading();
                
                if (reportResult && reportResult.report) {
                    // 显示报告内容
                    displayReport(reportResult.report);
                    
                    // 自动保存档案
                    setTimeout(async () => {
                        try {
                            const archiveTitle = `${window.familyInfo?.姓名 || '用户'}的家族寻根档案`;
                            await archiveSession(window.appState.sessionId, archiveTitle, '自动保存的寻根档案');
                            showSuccess('档案已自动保存！');
                        } catch (error) {
                            console.error('保存档案失败:', error);
                            // 不显示错误，用户可以手动保存
                        }
                    }, 1000);
                } else {
                    // 即使报告生成失败，也显示一个基本报告
                    const fallbackReport = {
                        title: `${window.familyInfo?.姓名 || '用户'}家族历史报告`,
                        summary: '基于您提供的信息生成的家族历史报告',
                        report_text: `亲爱的${window.familyInfo?.姓名 || '用户'}：

感谢您参与这次寻根之旅。虽然报告生成过程中遇到了一些技术问题，但我们已为您保存了所有收集到的信息。

**您提供的信息：**
${window.familyInfo ? JSON.stringify(window.familyInfo, null, 2) : '（信息较少，建议继续补充）'}

**下一步建议：**
1. 继续补充家族信息，特别是祖籍、祖父姓名等关键信息
2. 查看搜索到的历史大家族信息
3. 如有需要，可以重新生成报告

感谢您的参与！`
                    };
                    displayReport(fallbackReport);
                }
            } catch (error) {
                console.error('进入下一步失败:', error);
                const errorMsg = error.message || '操作失败，请重试';
                showError(errorMsg);
                addAIMessage(`操作失败：${errorMsg}。请检查网络连接后重试。`);
            }
        }
        
        
        // 添加AI消息
        function addAIMessage(message) {
            const chatContainer = document.getElementById('chat-container');
            const aiMessage = document.createElement('div');
            aiMessage.className = 'mb-4';
            aiMessage.innerHTML = `
                <div class="flex gap-3">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 ai-avatar" style="background: linear-gradient(135deg, #FF6B6B 0%, #4ECDC4 50%, #45B7D1 100%); box-shadow: 0 4px 12px rgba(78, 205, 196, 0.3);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                            <!-- 机器人头部 -->
                            <circle cx="12" cy="8" r="6" fill="white" opacity="0.9"/>
                            <!-- 眼睛 -->
                            <circle cx="10" cy="7" r="1.5" fill="#FF6B6B"/>
                            <circle cx="14" cy="7" r="1.5" fill="#FF6B6B"/>
                            <!-- 微笑 -->
                            <path d="M9 10 Q12 12 15 10" stroke="#4ECDC4" stroke-width="1" fill="none" stroke-linecap="round"/>
                            <!-- 天线 -->
                            <line x1="12" y1="2" x2="12" y2="4" stroke="white" stroke-width="2" stroke-linecap="round"/>
                            <circle cx="12" cy="1.5" r="1" fill="#45B7D1"/>
                        </svg>
                    </div>
                    <div class="max-w-[80%] px-4 py-3 rounded-lg"
                         style="background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(212, 175, 55, 0.15);">
                        <p style="color: #2E4B2C; font-family: 'Noto Sans SC', sans-serif; line-height: 1.6;">
                            ${message}
                        </p>
                    </div>
                </div>
            `;
            chatContainer.appendChild(aiMessage);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // 话题菜单切换函数
        let isTopicMenuOpen = false;
        
        function toggleTopicMenu() {
            const menu = document.getElementById('topic-menu');
            
            if (isTopicMenuOpen) {
                // 关闭菜单
                menu.classList.add('hidden');
                isTopicMenuOpen = false;
                document.removeEventListener('click', closeTopicMenuOnOutsideClick);
            } else {
                // 打开菜单
                menu.classList.remove('hidden');
                // 添加动画效果
                menu.style.animation = 'slideUp 0.3s ease-out';
                isTopicMenuOpen = true;
                
                // 点击外部关闭菜单
                setTimeout(() => {
                    document.addEventListener('click', closeTopicMenuOnOutsideClick);
                }, 100);
            }
        }
        
        function closeTopicMenuOnOutsideClick(event) {
            const menuContainer = document.getElementById('topic-menu-container');
            const menu = document.getElementById('topic-menu');
            
            if (!menuContainer.contains(event.target)) {
                menu.classList.add('hidden');
                isTopicMenuOpen = false;
                document.removeEventListener('click', closeTopicMenuOnOutsideClick);
            }
        }
        
        // 故事主题选择函数 - 已连接后端
        async function selectStoryTopic(topic) {
            const chatContainer = document.getElementById('chat-container');
            const menu = document.getElementById('topic-menu');
            
            // 关闭菜单
            menu.classList.add('hidden');
            isTopicMenuOpen = false;
            document.removeEventListener('click', closeTopicMenuOnOutsideClick);
            
            // 添加用户选择的消息
            const userMessage = document.createElement('div');
            userMessage.className = 'mb-4';
            userMessage.innerHTML = `
                <div class="flex gap-3 justify-end">
                    <div class="max-w-[80%] px-4 py-3 rounded-lg"
                         style="background: linear-gradient(135deg, #2E4B2C 0%, #3A5A3A 100%);
                                color: white;
                                font-family: 'Noto Sans SC', sans-serif;
                                line-height: 1.6;">
                        <div class="flex items-center gap-2 mb-2">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                            </svg>
                            <span>选择主题：${topic}</span>
                        </div>
                    </div>
                </div>
            `;
            chatContainer.appendChild(userMessage);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // 如果有sessionId，提交主题作为答案
            if (window.appState.sessionId) {
                try {
                    addAIMessage('正在处理您的选择...');
                    const result = await submitAnswer(window.appState.sessionId, `我想讲述关于${topic}的故事`);
                    
                    if (result.status === 'complete') {
                        addAIMessage('信息收集完成！');
                    } else if (result.question) {
                        setTimeout(() => {
                            addAIMessage(result.question);
                        }, 500);
                    }
                } catch (error) {
                    console.error('提交主题失败:', error);
                    // 如果提交失败，显示默认响应
                    showTopicResponse(topic);
                }
            } else {
                // 如果没有sessionId，显示默认响应
                showTopicResponse(topic);
            }
        }
        
        // 显示主题响应（备用）
        function showTopicResponse(topic) {
            let aiResponse = '';
            switch(topic) {
                case '家族历史':
                    aiResponse = '很好的选择！请告诉我关于您家族的历史故事，比如：\n\n• 家族的起源和发源地\n• 家族的发展历程\n• 重要的历史事件和人物\n• 家族的变迁和迁徙经历\n\n您可以从任何一个方面开始讲述。';
                    break;
                case '人物故事':
                    aiResponse = '人物故事最能体现家族的精神传承！请分享：\n\n• 家族中的代表性人物\n• 他们的生平事迹和品格\n• 对家族的贡献和影响\n• 值得传承的精神品质\n\n您可以讲述一位或多位家族成员的故事。';
                    break;
                case '传统习俗':
                    aiResponse = '传统习俗是家族文化的重要组成部分！请描述：\n\n• 家族的节日庆祝方式\n• 特殊的传统仪式\n• 代代相传的习俗习惯\n• 独特的家族文化实践\n\n我很期待了解您家族的独特传统。';
                    break;
                case '珍贵回忆':
                    aiResponse = '珍贵的回忆最动人！请分享：\n\n• 令人难忘的家庭时光\n• 感人的故事瞬间\n• 重要的生活转折点\n• 温馨的家庭记忆\n\n这些回忆将成为家族宝贵的财富。';
                    break;
                case '家族成就':
                    aiResponse = '家族成就是值得骄傲的传承！请讲述：\n\n• 家族成员的重要成就\n• 事业发展历程\n• 对社会的贡献\n• 值得纪念的成功故事\n\n这些成就将激励后代继续努力。';
                    break;
                case '家训家规':
                    aiResponse = '家训家规是家族智慧的结晶！请分享：\n\n• 家族的祖训和家规\n• 代代相传的价值观念\n• 家族精神的核心内容\n• 教育后人的理念和方法\n\n这些智慧将指引家族未来的方向。';
                    break;
                default:
                    aiResponse = '请开始讲述您选择的家族故事主题，我会仔细聆听并为您整理记录。';
            }
            
            setTimeout(() => {
                addAIMessage(aiResponse);
            }, 500);
        }
        
        // ==================== 报告页面功能 ====================
        
        /**
         * 加载报告到页面（兼容旧代码）
         */
        function loadReportToPage(report) {
            displayReport(report);
        }
        
        /**
         * 显示报告加载状态
         */
        function showReportLoading() {
            const loading = document.getElementById('report-loading');
            const content = document.getElementById('report-content');
            const error = document.getElementById('report-error');
            
            if (loading) loading.classList.remove('hidden');
            if (content) content.classList.add('hidden');
            if (error) error.classList.add('hidden');
        }
        
        /**
         * 显示报告内容
         */
        function displayReport(report) {
            const loading = document.getElementById('report-loading');
            const content = document.getElementById('report-content');
            const error = document.getElementById('report-error');
            const title = document.getElementById('report-title');
            const summary = document.getElementById('report-summary');
            const text = document.getElementById('report-text');
            
            if (loading) loading.classList.add('hidden');
            if (error) error.classList.add('hidden');
            if (content) content.classList.remove('hidden');
            
            if (title && report.title) {
                title.textContent = report.title;
            } else if (title) {
                title.textContent = '家族寻根报告';
            }
            
            if (summary && report.summary) {
                summary.textContent = report.summary;
            } else if (summary) {
                summary.textContent = '基于您提供的信息生成的家族历史报告';
            }
            
            if (text && report.report_text) {
                // 将报告文本转换为HTML，保持格式
                let reportHtml = report.report_text
                    .replace(/\*\*(.*?)\*\*/g, '<strong style="color: #2E4B2C; font-weight: 600;">$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/#{3}\s+(.*?)$/gm, '<h3 style="font-size: 1.2em; font-weight: 600; margin-top: 1.5em; margin-bottom: 0.5em; color: #2E4B2C;">$1</h3>')
                    .replace(/#{2}\s+(.*?)$/gm, '<h2 style="font-size: 1.5em; font-weight: 700; margin-top: 2em; margin-bottom: 1em; color: #2E4B2C;">$1</h2>')
                    .replace(/#{1}\s+(.*?)$/gm, '<h1 style="font-size: 1.8em; font-weight: 700; margin-top: 2em; margin-bottom: 1em; color: #2E4B2C;">$1</h1>')
                    .replace(/\n\n+/g, '</p><p style="margin-bottom: 1em; color: #2E4B2C; line-height: 1.8;">')
                    .replace(/\n/g, '<br>');
                
                text.innerHTML = `<p style="margin-bottom: 1em; color: #2E4B2C; line-height: 1.8;">${reportHtml}</p>`;
            } else if (text) {
                text.innerHTML = '<p style="color: #2E4B2C; line-height: 1.8;">报告内容加载中...</p>';
            }
        }
        
        /**
         * 显示报告错误
         */
        function showReportError(message) {
            const loading = document.getElementById('report-loading');
            const content = document.getElementById('report-content');
            const error = document.getElementById('report-error');
            
            if (loading) loading.classList.add('hidden');
            if (content) content.classList.add('hidden');
            if (error) {
                error.classList.remove('hidden');
                const errorMsg = error.querySelector('p');
                if (errorMsg) errorMsg.textContent = message;
            }
        }
        
        /**
         * 重新生成报告
         */
        async function retryGenerateReport() {
            if (!window.appState.sessionId) {
                showError('会话未创建');
                return;
            }
            
            showReportLoading();
            
            try {
                const reportResult = await generateReport(window.appState.sessionId);
                if (reportResult && reportResult.report) {
                    displayReport(reportResult.report);
                } else {
                    showReportError('报告生成失败，请重试');
                }
            } catch (error) {
                console.error('重新生成报告失败:', error);
                showReportError(`报告生成失败：${error.message || '未知错误'}`);
            }
        }
        
        /**
         * 保存报告为档案
         */
        async function saveReportAsArchive() {
            if (!window.appState.sessionId) {
                showError('会话未创建');
                return;
            }
            
            const title = prompt('请输入档案名称：', `${window.familyInfo?.姓名 || '用户'}的家族寻根档案`);
            if (!title) return;
            
            const notes = prompt('请输入备注（可选）：', '');
            
            try {
                await archiveSession(window.appState.sessionId, title, notes || '');
                showSuccess('档案保存成功！');
            } catch (error) {
                console.error('保存档案失败:', error);
                showError('保存档案失败，请重试');
            }
        }
        
        /**
         * 分享报告
         */
        function shareReport() {
            if (navigator.share) {
                const reportText = document.getElementById('report-text')?.textContent || '';
                navigator.share({
                    title: document.getElementById('report-title')?.textContent || '家族寻根报告',
                    text: reportText.substring(0, 200) + '...',
                    url: window.location.href
                }).catch(err => console.log('分享失败:', err));
            } else {
                // 复制到剪贴板
                const reportText = document.getElementById('report-text')?.textContent || '';
                navigator.clipboard.writeText(reportText).then(() => {
                    showSuccess('报告内容已复制到剪贴板');
                }).catch(err => {
                    console.error('复制失败:', err);
                    showError('复制失败，请手动复制');
                });
            }
        }
        
        // 交错动画初始化系统
        document.addEventListener('DOMContentLoaded', function() {
            // 设置表单验证
            setupInputValidation();
            
            // 初始化录音功能
            initRecording();
            
            // 支持回车键提交答案
            const answerInput = document.getElementById('answer-input');
            if (answerInput) {
                answerInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        submitTextAnswer();
                    }
                });
            }
            // 初始化欢迎页面的交错动画
            const welcomeStaggerItems = document.querySelectorAll('#welcome-page .stagger-item');
            welcomeStaggerItems.forEach((item, index) => {
                // 根据不同的元素类型设置不同的延迟
                if (item.classList.contains('stagger-title-root')) {
                    item.style.animationDelay = '0.3s';
                } else if (item.classList.contains('stagger-title-journey')) {
                    item.style.animationDelay = '0.5s';
                } else if (item.classList.contains('stagger-subtitle')) {
                    item.style.animationDelay = '0.7s';
                } else if (item.classList.contains('stagger-button')) {
                    item.style.animationDelay = '0.9s';
                } else if (item.classList.contains('stagger-decoration')) {
                    item.style.animationDelay = '1.1s';
                }
            });

            // 单独处理树图标动画
            const treeIcon = document.querySelector('#welcome-page .stagger-tree');
            if (treeIcon) {
                // 确保树图标有正确的动画
                treeIcon.style.animation = 'treeGrowth 1.2s cubic-bezier(0.34, 1.56, 0.64, 1) forwards, treeBreath 4s ease-in-out 1.5s infinite';
            }

            // 页面切换时重新初始化动画
            const welcomePage = document.getElementById('welcome-page');
            if (welcomePage) {
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                            if (welcomePage.classList.contains('active')) {
                                // 重新触发动画
                                resetAndRestartStaggerAnimation();
                            }
                        }
                    });
                });
                observer.observe(welcomePage, { attributes: true });
            }

            // 重置并重新启动动画的函数
            function resetAndRestartStaggerAnimation() {
                const items = document.querySelectorAll('#welcome-page .stagger-item');
                items.forEach(item => {
                    // 临时移除动画
                    item.style.animation = 'none';
                    item.offsetHeight; // 触发重排
                    
                    // 根据类名重新设置正确的动画
                    if (item.classList.contains('stagger-title-root')) {
                        item.style.animation = 'fadeInScale 0.8s cubic-bezier(0.4, 0, 0.2, 1) 0.3s forwards';
                    } else if (item.classList.contains('stagger-title-journey')) {
                        item.style.animation = 'fadeInScale 0.8s cubic-bezier(0.4, 0, 0.2, 1) 0.5s forwards';
                    } else if (item.classList.contains('stagger-subtitle')) {
                        item.style.animation = 'fadeInUp 0.8s cubic-bezier(0.4, 0, 0.2, 1) 0.7s forwards';
                    } else if (item.classList.contains('stagger-button')) {
                        item.style.animation = 'slideInUp 0.8s cubic-bezier(0.4, 0, 0.2, 1) 0.9s forwards';
                    } else if (item.classList.contains('stagger-decoration')) {
                        item.style.animation = 'slideInLeft 0.8s cubic-bezier(0.4, 0, 0.2, 1) 1.1s forwards';
                    }
                });

                // 单独处理树图标动画重置
                const treeIcon = document.querySelector('#welcome-page .stagger-tree');
                if (treeIcon) {
                    treeIcon.style.animation = 'none';
                    treeIcon.offsetHeight; // 触发重排
                    treeIcon.style.animation = 'treeGrowth 1.2s cubic-bezier(0.34, 1.56, 0.64, 1) forwards, treeBreath 4s ease-in-out 1.5s infinite';
                }
            }
            
            // 页面加载完成后的入场动画
            document.body.style.opacity = '0';
            document.body.style.transition = 'opacity 0.8s ease-out';
            
            setTimeout(() => {
                document.body.style.opacity = '1';
            }, 100);
        });
        
        // 头像上传和拍照功能
        document.addEventListener('DOMContentLoaded', function() {
            const avatarContainer = document.getElementById('avatar-container');
            const avatarInput = document.getElementById('avatar-input');
            const uploadedAvatar = document.getElementById('uploaded-avatar');
            const defaultAvatar = document.getElementById('default-avatar');
            const qualityAlert = document.getElementById('quality-alert');
            
            // 点击头像触发文件选择
            avatarContainer.addEventListener('click', function() {
                // 显示选择菜单
                showAvatarOptions();
            });
            
            // 显示头像选择选项
            function showAvatarOptions() {
                createAvatarSelectionModal();
            }
            
            // 创建头像选择模态框
            function createAvatarSelectionModal() {
                // 移除已存在的模态框
                const existingModal = document.getElementById('avatar-selection-modal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // 创建模态框
                const modal = document.createElement('div');
                modal.id = 'avatar-selection-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-end justify-center z-50 transition-opacity duration-300';
                modal.style.opacity = '0';
                
                // 创建内容区域
                const content = document.createElement('div');
                content.className = 'bg-white rounded-t-3xl w-full max-w-md p-6 transform translate-y-full transition-transform duration-300';
                content.style.paddingBottom = 'calc(var(--spacing-unit) * 8)';
                
                // 标题
                const title = document.createElement('h3');
                title.className = 'text-xl font-bold text-center mb-6';
                title.style.fontFamily = "'Noto Sans SC', serif";
                title.style.color = '#2E4B2C';
                title.textContent = '选择头像来源';
                
                // 选项容器
                const optionsContainer = document.createElement('div');
                optionsContainer.className = 'space-y-3';
                
                // 拍照选项
                const cameraOption = createOptionButton('📷 现场拍照', '使用摄像头拍摄新照片', () => {
                    handleCameraSelection();
                });
                
                // 相册选项
                const galleryOption = createOptionButton('🖼️ 从相册选择', '从手机相册中选择照片', () => {
                    handleGallerySelection();
                });
                
                // 取消按钮
                const cancelButton = document.createElement('button');
                cancelButton.className = 'w-full py-3 rounded-2xl bg-gray-100 text-gray-700 font-medium transition-all duration-300 hover:bg-gray-200 active:scale-[0.98]';
                cancelButton.style.fontFamily = "'Noto Sans SC', sans-serif";
                cancelButton.textContent = '取消';
                cancelButton.addEventListener('click', () => {
                    removeModal();
                });
                
                // 组装内容
                optionsContainer.appendChild(cameraOption);
                optionsContainer.appendChild(galleryOption);
                content.appendChild(title);
                content.appendChild(optionsContainer);
                content.appendChild(cancelButton);
                modal.appendChild(content);
                
                // 添加到页面
                document.body.appendChild(modal);
                
                // 动画显示
                setTimeout(() => {
                    modal.style.opacity = '1';
                    content.style.transform = 'translateY(0)';
                }, 50);
                
                // 点击背景关闭
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        removeModal();
                    }
                });
                
                // 移除模态框的函数
                function removeModal() {
                    modal.style.opacity = '0';
                    content.style.transform = 'translateY(100%)';
                    setTimeout(() => {
                        modal.remove();
                    }, 300);
                }
            }
            
            // 创建选项按钮
            function createOptionButton(icon, text, onClick) {
                const button = document.createElement('button');
                button.className = 'w-full p-4 rounded-2xl border border-gray-200 flex items-center gap-4 transition-all duration-300 hover:bg-gray-50 hover:border-[#2E4B2C] active:scale-[0.98]';
                button.style.fontFamily = "'Noto Sans SC', sans-serif";
                button.style.color = '#2E4B2C';
                
                const iconSpan = document.createElement('span');
                iconSpan.className = 'text-2xl';
                iconSpan.textContent = icon;
                
                const textDiv = document.createElement('div');
                textDiv.className = 'text-left';
                
                const mainText = document.createElement('div');
                mainText.className = 'font-medium text-base';
                mainText.textContent = text;
                
                textDiv.appendChild(mainText);
                button.appendChild(iconSpan);
                button.appendChild(textDiv);
                
                button.addEventListener('click', onClick);
                
                return button;
            }
            
            // 处理拍照选择
            async function handleCameraSelection() {
                // 移除模态框
                const modal = document.getElementById('avatar-selection-modal');
                if (modal) {
                    modal.remove();
                }
                
                // 检查摄像头支持
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    showQualityAlert('⚠️ 您的设备不支持摄像头功能', 'error');
                    return;
                }
                
                // 显示摄像头选择
                setTimeout(() => {
                    showCameraChoice();
                }, 300);
            }
            
            // 显示摄像头选择（前置/后置）
            function showCameraChoice() {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                
                const content = document.createElement('div');
                content.className = 'bg-white rounded-3xl p-6 m-4 max-w-sm w-full';
                
                const title = document.createElement('h3');
                title.className = 'text-lg font-bold text-center mb-4';
                title.style.fontFamily = "'Noto Sans SC', serif";
                title.style.color = '#2E4B2C';
                title.textContent = '选择摄像头';
                
                const options = document.createElement('div');
                options.className = 'space-y-3';
                
                const backCameraBtn = document.createElement('button');
                backCameraBtn.className = 'w-full p-3 rounded-xl bg-green-50 text-green-700 font-medium hover:bg-green-100 transition-colors';
                backCameraBtn.style.fontFamily = "'Noto Sans SC', sans-serif";
                backCameraBtn.textContent = '📷 后置摄像头';
                backCameraBtn.addEventListener('click', async () => {
                    modal.remove();
                    await capturePhoto('environment');
                });
                
                const frontCameraBtn = document.createElement('button');
                frontCameraBtn.className = 'w-full p-3 rounded-xl bg-blue-50 text-blue-700 font-medium hover:bg-blue-100 transition-colors';
                frontCameraBtn.style.fontFamily = "'Noto Sans SC', sans-serif";
                frontCameraBtn.textContent = '🤳 前置摄像头（自拍）';
                frontCameraBtn.addEventListener('click', async () => {
                    modal.remove();
                    await capturePhoto('user');
                });
                
                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'w-full p-3 rounded-xl bg-gray-100 text-gray-700 font-medium hover:bg-gray-200 transition-colors mt-2';
                cancelBtn.style.fontFamily = "'Noto Sans SC', sans-serif";
                cancelBtn.textContent = '取消';
                cancelBtn.addEventListener('click', () => {
                    modal.remove();
                });
                
                options.appendChild(backCameraBtn);
                options.appendChild(frontCameraBtn);
                options.appendChild(cancelBtn);
                
                content.appendChild(title);
                content.appendChild(options);
                modal.appendChild(content);
                
                document.body.appendChild(modal);
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }
            
            // 使用getUserMedia API进行拍照
            async function capturePhoto(cameraType) {
                try {
                    // 显示加载提示
                    showQualityAlert('📷 正在启动摄像头...', 'info');
                    
                    // 请求摄像头权限
                    const constraints = {
                        video: {
                            facingMode: cameraType,
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        }
                    };
                    
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    // 创建视频预览
                    const previewModal = createCameraPreview(stream);
                    document.body.appendChild(previewModal);
                    
                    // 动画显示
                    setTimeout(() => {
                        previewModal.style.opacity = '1';
                        previewModal.querySelector('.camera-preview-content').style.transform = 'scale(1)';
                    }, 50);
                    
                } catch (error) {
                    console.error('摄像头访问失败:', error);
                    
                    // 如果getUserMedia失败，回退到文件input
                    fallbackToFileInput(cameraType);
                }
            }
            
            // 创建摄像头预览界面
            function createCameraPreview(stream) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black z-50 flex items-center justify-center';
                modal.style.opacity = '0';
                modal.style.transition = 'opacity 0.3s ease';
                
                const content = document.createElement('div');
                content.className = 'relative w-full h-full flex flex-col items-center justify-center camera-preview-content';
                content.style.transform = 'scale(0.8)';
                content.style.transition = 'transform 0.3s ease';
                
                // 创建视频元素
                const video = document.createElement('video');
                video.className = 'w-full h-full object-cover';
                video.autoplay = true;
                video.srcObject = stream;
                
                // 创建控制按钮区域
                const controls = document.createElement('div');
                controls.className = 'absolute bottom-8 left-1/2 transform -translate-x-1/2 flex items-center gap-4 bg-black bg-opacity-50 rounded-full px-6 py-3';
                
                // 拍照按钮
                const captureBtn = document.createElement('button');
                captureBtn.className = 'w-16 h-16 bg-white rounded-full flex items-center justify-center hover:bg-gray-100 transition-colors';
                captureBtn.innerHTML = `
                    <div class="w-12 h-12 bg-red-500 rounded-full"></div>
                `;
                captureBtn.addEventListener('click', () => {
                    takePicture(video, stream, modal);
                });
                
                // 取消按钮
                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'text-white text-sm font-medium hover:text-gray-300 transition-colors';
                cancelBtn.textContent = '取消';
                cancelBtn.addEventListener('click', () => {
                    stopCamera(stream, modal);
                });
                
                controls.appendChild(cancelBtn);
                controls.appendChild(captureBtn);
                
                content.appendChild(video);
                content.appendChild(controls);
                modal.appendChild(content);
                
                return modal;
            }
            
            // 拍照
            function takePicture(video, stream, modal) {
                // 创建canvas来捕获图像
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);
                
                // 停止摄像头
                stopCamera(stream, modal);
                
                // 转换为文件
                canvas.toBlob((blob) => {
                    const file = new File([blob], 'camera_photo.jpg', { type: 'image/jpeg' });
                    
                    // 处理图片
                    checkImageQuality(file).then(qualityCheck => {
                        if (qualityCheck.passed) {
                            displayImage(file);
                            showQualityAlert('✓ 拍照成功，图片质量良好', 'success');
                        } else {
                            displayImage(file);
                            showQualityAlert(qualityCheck.message, 'warning');
                        }
                    });
                }, 'image/jpeg', 0.9);
            }
            
            // 停止摄像头
            function stopCamera(stream, modal) {
                // 停止所有视频轨道
                stream.getTracks().forEach(track => track.stop());
                
                // 移除预览
                modal.style.opacity = '0';
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
            
            // 回退到文件input方式
            function fallbackToFileInput(cameraType) {
                showQualityAlert('⚠️ 正在使用备用拍照方式...', 'info');
                
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.capture = cameraType;
                input.style.display = 'none';
                
                input.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        checkImageQuality(file).then(qualityCheck => {
                            if (qualityCheck.passed) {
                                displayImage(file);
                                showQualityAlert('✓ 图片上传成功', 'success');
                            } else {
                                displayImage(file);
                                showQualityAlert(qualityCheck.message, 'warning');
                            }
                        });
                    }
                    input.remove();
                });
                
                document.body.appendChild(input);
                input.click();
            }
            
            // 处理相册选择
            function handleGallerySelection() {
                // 移除模态框
                const modal = document.getElementById('avatar-selection-modal');
                if (modal) {
                    modal.remove();
                }
                
                // 设置为相册模式
                avatarInput.removeAttribute('capture');
                avatarInput.accept = 'image/*';
                
                // 延迟触发文件选择，等待模态框关闭动画
                setTimeout(() => {
                    avatarInput.click();
                }, 300);
            }
            
            // 统一处理文件选择
            function handleFileSelect(e) {
                const file = e.target.files[0];
                if (file) {
                    checkImageQuality(file).then(qualityCheck => {
                        if (qualityCheck.passed) {
                            displayImage(file);
                            showQualityAlert('✓ 图片质量良好', 'success');
                        } else {
                            displayImage(file);
                            showQualityAlert(qualityCheck.message, 'warning');
                        }
                    });
                }
                // 清理临时input
                if (e.target !== avatarInput) {
                    e.target.remove();
                }
            }
            
            // 处理文件选择
            avatarInput.addEventListener('change', handleFileSelect);
            
            // 图片质量检测
            function checkImageQuality(file) {
                const maxSize = 5 * 1024 * 1024; // 5MB
                const minSize = 10 * 1024; // 10KB
                const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
                
                // 检查文件类型
                if (!validTypes.includes(file.type)) {
                    return {
                        passed: false,
                        message: '⚠️ 建议使用 JPG/PNG 格式'
                    };
                }
                
                // 检查文件大小
                if (file.size > maxSize) {
                    return {
                        passed: false,
                        message: '⚠️ 图片过大，建议压缩后上传'
                    };
                }
                
                if (file.size < minSize) {
                    return {
                        passed: false,
                        message: '⚠️ 图片过小，可能影响清晰度'
                    };
                }
                
                // 检查分辨率（需要加载图片后检查）
                return new Promise((resolve) => {
                    const img = new Image();
                    const url = URL.createObjectURL(file);
                    
                    img.onload = function() {
                        URL.revokeObjectURL(url);
                        
                        const width = img.width;
                        const height = img.height;
                        const minDimension = 200; // 最小尺寸要求
                        const maxDimension = 2000; // 最大尺寸限制
                        
                        if (width < minDimension || height < minDimension) {
                            resolve({
                                passed: false,
                                message: '⚠️ 建议使用更高分辨率的图片'
                            });
                            return;
                        }
                        
                        if (width > maxDimension || height > maxDimension) {
                            resolve({
                                passed: false,
                                message: '⚠️ 图片分辨率过高，建议压缩'
                            });
                            return;
                        }
                        
                        // 检查宽高比（避免极端比例）
                        const aspectRatio = Math.max(width, height) / Math.min(width, height);
                        if (aspectRatio > 3) {
                            resolve({
                                passed: false,
                                message: '⚠️ 建议使用更接近正方形的图片'
                            });
                            return;
                        }
                        
                        resolve({
                            passed: true,
                            message: '✓ 图片质量优秀'
                        });
                    };
                    
                    img.onerror = function() {
                        URL.revokeObjectURL(url);
                        resolve({
                            passed: false,
                            message: '⚠️ 图片加载失败'
                        });
                    };
                    
                    img.src = url;
                });
            }
            
            // 显示图片
            function displayImage(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedAvatar.src = e.target.result;
                    uploadedAvatar.classList.remove('hidden');
                    defaultAvatar.classList.add('hidden');
                    
                    // 添加图片加载动画
                    uploadedAvatar.style.opacity = '0';
                    uploadedAvatar.style.transition = 'opacity 0.5s ease-in-out';
                    setTimeout(() => {
                        uploadedAvatar.style.opacity = '1';
                    }, 100);
                };
                reader.readAsDataURL(file);
            }
            
            // 显示质量提示
            function showQualityAlert(message, type) {
                qualityAlert.textContent = message;
                qualityAlert.classList.remove('hidden');
                
                if (type === 'success') {
                    qualityAlert.style.background = 'rgba(76, 175, 80, 0.9)';
                } else if (type === 'warning') {
                    qualityAlert.style.background = 'rgba(255, 152, 0, 0.9)';
                } else if (type === 'info') {
                    qualityAlert.style.background = 'rgba(33, 150, 243, 0.9)';
                } else {
                    qualityAlert.style.background = 'rgba(244, 67, 54, 0.9)';
                }
                
                // 3秒后自动隐藏
                setTimeout(() => {
                    qualityAlert.classList.add('hidden');
                }, 3000);
            }
            
            // 检测设备摄像头支持
            function checkCameraSupport() {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    console.log('设备不支持摄像头功能');
                    return false;
                }
                return true;
            }
            
            // 初始化摄像头支持检测
            if (checkCameraSupport()) {
                console.log('设备支持摄像头功能');
            }
        });

        // 尊重用户减少动效偏好
        if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
            document.querySelectorAll('*').forEach(el => {
                el.style.animation = 'none';
                el.style.transition = 'none';
            });
        }
    </script>

</body>
</html>