# 搜索逻辑改进说明

## 改进内容

### 问题
之前的逻辑尝试从未解析对话中提取关键词（姓氏、地区、祖父姓名等），但提取逻辑复杂且容易出错，导致信息丢失（如祖父姓名无法提取）。

### 解决方案
**不再提取关键词，直接将所有对话内容传递给LLM，让LLM自己理解和提取信息。**

## 具体改进

### 1. 移除关键词提取逻辑

**之前**：
- 使用正则表达式从未解析对话中提取姓氏、地区、祖父姓名
- 提取逻辑复杂，容易出错
- 信息可能丢失

**现在**：
- 不再提取关键词
- 直接将所有对话内容传递给LLM
- LLM可以自己理解和提取所有信息

### 2. 保留结构化信息

**保留**：
- 用户初始输入的结构化信息（姓名、出生地等）
- AI成功提取的结构化信息（self.surname, self.origin等）
- 从祖父姓名推导姓氏的逻辑（因为这是从已提取信息推导）

### 3. 增强搜索提示词

**改进**：
- 在搜索提示词中包含所有对话内容
- 明确要求LLM仔细阅读对话内容并提取信息
- 提供完整的用户信息上下文

## 数据流程

### 之前
```
用户对话 → 尝试提取关键词 → 可能丢失信息 → 搜索
```

### 现在
```
用户对话 → 直接传递给LLM → LLM自己理解 → 搜索
```

## 信息传递方式

### 结构化信息（保留）
```
- 姓氏：张（来自 self.surname）
- 祖籍/籍贯：山东（来自 self.origin）
- 父亲籍贯：山东济南（来自 father.origin）
- 祖父姓名：张建国（来自 grandfather.name）
- 辈分字：建（来自 self.generation_name）
```

### 对话内容（新增）
```
完整对话记录（包含所有用户提供的信息）：
Q: 你的祖籍/籍贯大概在什么地方？
A: 我的祖籍是山东

Q: 你家族的姓氏是？
A: 我姓张

Q: 你父亲小时候是在山东长大的吗？
A: 我爷爷叫张建国

Q: 你爸爸常提起过他的老家吗？
A: 我爸爸的老家在山东济南
```

### 用户初始信息（保留）
```
用户初始信息：
- 姓名：张三
- 出生地：北京
- 当前地区：上海
```

## 优势

### 1. 不丢失信息
- 所有对话内容都传递给LLM
- LLM可以自己理解和提取信息
- 不会因为提取逻辑错误而丢失信息

### 2. 更灵活
- LLM可以理解自然语言
- 支持多种表达方式
- 可以提取复杂的信息

### 3. 更简单
- 不需要复杂的正则表达式
- 不需要维护提取逻辑
- 代码更简洁

## 示例

### 场景：用户说"我爷爷叫张建国"

**之前**：
- 尝试用正则表达式提取
- 如果正则不匹配，信息丢失
- 祖父姓名无法提取

**现在**：
- 直接将"我爷爷叫张建国"传递给LLM
- LLM可以理解并提取"张建国"作为祖父姓名
- 信息不会丢失

## 注意事项

### 1. LLM理解能力
- 依赖LLM的理解能力
- 如果LLM理解错误，可能影响搜索结果
- 但通常LLM的理解能力比正则表达式更强

### 2. 提示词设计
- 需要明确要求LLM提取信息
- 需要提供足够的上下文
- 需要强调关键信息（如姓氏、地区）

### 3. 性能
- 传递更多信息给LLM
- 可能略微增加处理时间
- 但通常影响不大

## 相关文件

- `backend/app/services/search_service.py` - 搜索服务逻辑
- `backend/test_data_extraction.py` - 测试脚本

---

**改进完成时间**：2024-01-01  
**改进原因**：避免信息丢失，特别是祖父姓名等关键信息
